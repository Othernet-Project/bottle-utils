<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>bottle &mdash; Bottle Utils 0.3 documentation</title>
    
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Bottle Utils 0.3 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Bottle Utils 0.3 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for bottle</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Bottle is a fast and simple micro-framework for small web applications. It</span>
<span class="sd">offers request dispatching (Routes) with url parameter support, templates,</span>
<span class="sd">a built-in HTTP Server and adapters for many third party WSGI/HTTP-server and</span>
<span class="sd">template engines - all in a single file and with no dependencies other than the</span>
<span class="sd">Python Standard Library.</span>

<span class="sd">Homepage and documentation: http://bottlepy.org/</span>

<span class="sd">Copyright (c) 2013, Marcel Hellkamp.</span>
<span class="sd">License: MIT (see LICENSE for details)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">with_statement</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;Marcel Hellkamp&#39;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s">&#39;0.12.7&#39;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s">&#39;MIT&#39;</span>

<span class="c"># The gevent server adapter needs to patch some modules before they are imported</span>
<span class="c"># This is why we parse the commandline parameters here but handle them later</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">OptionParser</span>
    <span class="n">_cmd_parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span><span class="o">=</span><span class="s">&quot;usage: %prog [options] package.module:app&quot;</span><span class="p">)</span>
    <span class="n">_opt</span> <span class="o">=</span> <span class="n">_cmd_parser</span><span class="o">.</span><span class="n">add_option</span>
    <span class="n">_opt</span><span class="p">(</span><span class="s">&quot;--version&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;show version number.&quot;</span><span class="p">)</span>
    <span class="n">_opt</span><span class="p">(</span><span class="s">&quot;-b&quot;</span><span class="p">,</span> <span class="s">&quot;--bind&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&quot;ADDRESS&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;bind socket to ADDRESS.&quot;</span><span class="p">)</span>
    <span class="n">_opt</span><span class="p">(</span><span class="s">&quot;-s&quot;</span><span class="p">,</span> <span class="s">&quot;--server&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;wsgiref&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;use SERVER as backend.&quot;</span><span class="p">)</span>
    <span class="n">_opt</span><span class="p">(</span><span class="s">&quot;-p&quot;</span><span class="p">,</span> <span class="s">&quot;--plugin&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;append&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;install additional plugin/s.&quot;</span><span class="p">)</span>
    <span class="n">_opt</span><span class="p">(</span><span class="s">&quot;--debug&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;start server in debug mode.&quot;</span><span class="p">)</span>
    <span class="n">_opt</span><span class="p">(</span><span class="s">&quot;--reload&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;auto-reload on file changes.&quot;</span><span class="p">)</span>
    <span class="n">_cmd_options</span><span class="p">,</span> <span class="n">_cmd_args</span> <span class="o">=</span> <span class="n">_cmd_parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">_cmd_options</span><span class="o">.</span><span class="n">server</span> <span class="ow">and</span> <span class="n">_cmd_options</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;gevent&#39;</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">gevent.monkey</span><span class="p">;</span> <span class="n">gevent</span><span class="o">.</span><span class="n">monkey</span><span class="o">.</span><span class="n">patch_all</span><span class="p">()</span>

<span class="kn">import</span> <span class="nn">base64</span><span class="o">,</span> <span class="nn">cgi</span><span class="o">,</span> <span class="nn">email.utils</span><span class="o">,</span> <span class="nn">functools</span><span class="o">,</span> <span class="nn">hmac</span><span class="o">,</span> <span class="nn">imp</span><span class="o">,</span> <span class="nn">itertools</span><span class="o">,</span> <span class="nn">mimetypes</span><span class="o">,</span>\
        <span class="nn">os</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">subprocess</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">tempfile</span><span class="o">,</span> <span class="nn">threading</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span> <span class="k">as</span> <span class="n">datedate</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">TemporaryFile</span>
<span class="kn">from</span> <span class="nn">traceback</span> <span class="kn">import</span> <span class="n">format_exc</span><span class="p">,</span> <span class="n">print_exc</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">getargspec</span>
<span class="kn">from</span> <span class="nn">unicodedata</span> <span class="kn">import</span> <span class="n">normalize</span>


<span class="k">try</span><span class="p">:</span> <span class="kn">from</span> <span class="nn">simplejson</span> <span class="kn">import</span> <span class="n">dumps</span> <span class="k">as</span> <span class="n">json_dumps</span><span class="p">,</span> <span class="n">loads</span> <span class="k">as</span> <span class="n">json_lds</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span> <span class="c"># pragma: no cover</span>
    <span class="k">try</span><span class="p">:</span> <span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">dumps</span> <span class="k">as</span> <span class="n">json_dumps</span><span class="p">,</span> <span class="n">loads</span> <span class="k">as</span> <span class="n">json_lds</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span> <span class="kn">from</span> <span class="nn">django.utils.simplejson</span> <span class="kn">import</span> <span class="n">dumps</span> <span class="k">as</span> <span class="n">json_dumps</span><span class="p">,</span> <span class="n">loads</span> <span class="k">as</span> <span class="n">json_lds</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">json_dumps</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s">&quot;JSON support requires Python 2.6 or simplejson.&quot;</span><span class="p">)</span>
            <span class="n">json_lds</span> <span class="o">=</span> <span class="n">json_dumps</span>



<span class="c"># We now try to fix 2.5/2.6/3.1/3.2 incompatibilities.</span>
<span class="c"># It ain&#39;t pretty but it works... Sorry for the mess.</span>

<span class="n">py</span>   <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span>
<span class="n">py3k</span> <span class="o">=</span> <span class="n">py</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">py25</span> <span class="o">=</span> <span class="n">py</span> <span class="o">&lt;</span>  <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">py31</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">py</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="c"># Workaround for the missing &quot;as&quot; keyword in py3k.</span>
<span class="k">def</span> <span class="nf">_e</span><span class="p">():</span> <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>

<span class="c"># Workaround for the &quot;print is a keyword/function&quot; Python 2/3 dilemma</span>
<span class="c"># and a fallback for mod_wsgi (resticts stdout/err attribute access)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">_stdout</span><span class="p">,</span> <span class="n">_stderr</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span>
<span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
    <span class="n">_stdout</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">_stderr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c"># Lots of stdlib and builtin differences.</span>
<span class="k">if</span> <span class="n">py3k</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">http.client</span> <span class="kn">as</span> <span class="nn">httplib</span>
    <span class="kn">import</span> <span class="nn">_thread</span> <span class="kn">as</span> <span class="nn">thread</span>
    <span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urljoin</span><span class="p">,</span> <span class="n">SplitResult</span> <span class="k">as</span> <span class="n">UrlSplitResult</span>
    <span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlencode</span><span class="p">,</span> <span class="n">quote</span> <span class="k">as</span> <span class="n">urlquote</span><span class="p">,</span> <span class="n">unquote</span> <span class="k">as</span> <span class="n">urlunquote</span>
    <span class="n">urlunquote</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">urlunquote</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;latin1&#39;</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">http.cookies</span> <span class="kn">import</span> <span class="n">SimpleCookie</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">MutableMapping</span> <span class="k">as</span> <span class="n">DictMixin</span>
    <span class="kn">import</span> <span class="nn">pickle</span>
    <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
    <span class="kn">from</span> <span class="nn">configparser</span> <span class="kn">import</span> <span class="n">ConfigParser</span>
    <span class="nb">basestring</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="nb">unicode</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="n">json_loads</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">json_lds</span><span class="p">(</span><span class="n">touni</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
    <span class="nb">callable</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s">&#39;__call__&#39;</span><span class="p">)</span>
    <span class="n">imap</span> <span class="o">=</span> <span class="nb">map</span>
    <span class="k">def</span> <span class="nf">_raise</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">):</span> <span class="k">raise</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span> <span class="c"># 2.x</span>
    <span class="kn">import</span> <span class="nn">httplib</span>
    <span class="kn">import</span> <span class="nn">thread</span>
    <span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">urljoin</span><span class="p">,</span> <span class="n">SplitResult</span> <span class="k">as</span> <span class="n">UrlSplitResult</span>
    <span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">urlencode</span><span class="p">,</span> <span class="n">quote</span> <span class="k">as</span> <span class="n">urlquote</span><span class="p">,</span> <span class="n">unquote</span> <span class="k">as</span> <span class="n">urlunquote</span>
    <span class="kn">from</span> <span class="nn">Cookie</span> <span class="kn">import</span> <span class="n">SimpleCookie</span>
    <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">imap</span>
    <span class="kn">import</span> <span class="nn">cPickle</span> <span class="kn">as</span> <span class="nn">pickle</span>
    <span class="kn">from</span> <span class="nn">StringIO</span> <span class="kn">import</span> <span class="n">StringIO</span> <span class="k">as</span> <span class="n">BytesIO</span>
    <span class="kn">from</span> <span class="nn">ConfigParser</span> <span class="kn">import</span> <span class="n">SafeConfigParser</span> <span class="k">as</span> <span class="n">ConfigParser</span>
    <span class="k">if</span> <span class="n">py25</span><span class="p">:</span>
        <span class="n">msg</span>  <span class="o">=</span> <span class="s">&quot;Python 2.5 support may be dropped in future versions of Bottle.&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">UserDict</span> <span class="kn">import</span> <span class="n">DictMixin</span>
        <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="n">it</span><span class="p">):</span> <span class="k">return</span> <span class="n">it</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="nb">bytes</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="k">else</span><span class="p">:</span> <span class="c"># 2.6, 2.7</span>
        <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">MutableMapping</span> <span class="k">as</span> <span class="n">DictMixin</span>
    <span class="nb">unicode</span> <span class="o">=</span> <span class="nb">unicode</span>
    <span class="n">json_loads</span> <span class="o">=</span> <span class="n">json_lds</span>
    <span class="nb">eval</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="s">&#39;def _raise(*a): raise a[0], a[1], a[2]&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;py3fix&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;exec&#39;</span><span class="p">))</span>

<span class="c"># Some helpers for string/byte handling</span>
<span class="k">def</span> <span class="nf">tob</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">enc</span><span class="o">=</span><span class="s">&#39;utf8&#39;</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)</span> <span class="k">else</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">touni</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">enc</span><span class="o">=</span><span class="s">&#39;utf8&#39;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="s">&#39;strict&#39;</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">enc</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="n">tonat</span> <span class="o">=</span> <span class="n">touni</span> <span class="k">if</span> <span class="n">py3k</span> <span class="k">else</span> <span class="n">tob</span>

<span class="c"># 3.2 fixes cgi.FieldStorage to accept bytes (which makes a lot of sense).</span>
<span class="c"># 3.1 needs a workaround.</span>
<span class="k">if</span> <span class="n">py31</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">TextIOWrapper</span>
    <span class="k">class</span> <span class="nc">NCTextIOWrapper</span><span class="p">(</span><span class="n">TextIOWrapper</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span> <span class="c"># Keep wrapped buffer open.</span>


<span class="c"># A bug in functools causes it to break if the wrapper is an instance method</span>
<span class="k">def</span> <span class="nf">update_wrapper</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">wrapped</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">ka</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span> <span class="n">functools</span><span class="o">.</span><span class="n">update_wrapper</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">wrapped</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">ka</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> <span class="k">pass</span>



<span class="c"># These helpers are used at module level and need to be defined first.</span>
<span class="c"># And yes, I know PEP-8, but sometimes a lower-case classname makes more sense.</span>

<span class="k">def</span> <span class="nf">depr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">hard</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">makelist</span><span class="p">(</span><span class="n">data</span><span class="p">):</span> <span class="c"># This is just to handy</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span> <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">data</span><span class="p">:</span> <span class="k">return</span> <span class="p">[</span><span class="n">data</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="p">[]</span>


<span class="k">class</span> <span class="nc">DictProperty</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Property that maps to a key in a local dict-like attribute. &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="o">=</span> <span class="n">attr</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">read_only</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="n">functools</span><span class="o">.</span><span class="n">update_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">updated</span><span class="o">=</span><span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">or</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">storage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">storage</span><span class="p">:</span> <span class="n">storage</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getter</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">storage</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&quot;Read-Only property.&quot;</span><span class="p">)</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__delete__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&quot;Read-Only property.&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">cached_property</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; A property that is only computed once per instance and then replaces</span>
<span class="sd">        itself with an ordinary attribute. Deleting the attribute resets the</span>
<span class="sd">        property. &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s">&#39;__doc__&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">lazy_attribute</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; A property that caches itself to the class object. &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="n">functools</span><span class="o">.</span><span class="n">update_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">updated</span><span class="o">=</span><span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getter</span> <span class="o">=</span> <span class="n">func</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getter</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>






<span class="c">###############################################################################</span>
<span class="c"># Exceptions and Events ########################################################</span>
<span class="c">###############################################################################</span>


<span class="k">class</span> <span class="nc">BottleException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A base class for exceptions used by bottle. &quot;&quot;&quot;</span>
    <span class="k">pass</span>






<span class="c">###############################################################################</span>
<span class="c"># Routing ######################################################################</span>
<span class="c">###############################################################################</span>


<span class="k">class</span> <span class="nc">RouteError</span><span class="p">(</span><span class="n">BottleException</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This is a base class for all routing related exceptions &quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">RouteReset</span><span class="p">(</span><span class="n">BottleException</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; If raised by a plugin or request handler, the route is reset and all</span>
<span class="sd">        plugins are re-applied. &quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">RouterUnknownModeError</span><span class="p">(</span><span class="n">RouteError</span><span class="p">):</span> <span class="k">pass</span>


<span class="k">class</span> <span class="nc">RouteSyntaxError</span><span class="p">(</span><span class="n">RouteError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; The route parser found something not supported by this router. &quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">RouteBuildError</span><span class="p">(</span><span class="n">RouteError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; The route could not be built. &quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">_re_flatten</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Turn all capturing groups in a regular expression pattern into</span>
<span class="sd">        non-capturing groups. &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="s">&#39;(&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span> <span class="k">return</span> <span class="n">p</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&#39;(</span><span class="se">\\</span><span class="s">*)(\(\?P&lt;[^&gt;]+&gt;|\((?!\?))&#39;</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">%</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;(?:&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Router</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; A Router is an ordered collection of route-&gt;target pairs. It is used to</span>
<span class="sd">        efficiently match WSGI requests against a number of routes and return</span>
<span class="sd">        the first target that satisfies the request. The target may be anything,</span>
<span class="sd">        usually a string, ID or callable object. A route consists of a path-rule</span>
<span class="sd">        and a HTTP method.</span>

<span class="sd">        The path-rule is either a static path (e.g. `/contact`) or a dynamic</span>
<span class="sd">        path that contains wildcards (e.g. `/wiki/&lt;page&gt;`). The wildcard syntax</span>
<span class="sd">        and details on the matching order are described in docs:`routing`.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">default_pattern</span> <span class="o">=</span> <span class="s">&#39;[^/]+&#39;</span>
    <span class="n">default_filter</span>  <span class="o">=</span> <span class="s">&#39;re&#39;</span>

    <span class="c">#: The current CPython regexp implementation does not allow more</span>
    <span class="c">#: than 99 matching groups per regular expression.</span>
    <span class="n">_MAX_GROUPS_PER_PATTERN</span> <span class="o">=</span> <span class="mi">99</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span>    <span class="o">=</span> <span class="p">[]</span> <span class="c"># All rules in order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span>  <span class="o">=</span> <span class="p">{}</span> <span class="c"># index of regexes to find them in dyna_routes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">builder</span>  <span class="o">=</span> <span class="p">{}</span> <span class="c"># Data structure for the url builder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">static</span>   <span class="o">=</span> <span class="p">{}</span> <span class="c"># Search structure for static routes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dyna_routes</span>   <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dyna_regexes</span>  <span class="o">=</span> <span class="p">{}</span> <span class="c"># Search structure for dynamic routes</span>
        <span class="c">#: If true, static routes are no longer checked first.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strict_order</span> <span class="o">=</span> <span class="n">strict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;re&#39;</span><span class="p">:</span>    <span class="k">lambda</span> <span class="n">conf</span><span class="p">:</span>
                <span class="p">(</span><span class="n">_re_flatten</span><span class="p">(</span><span class="n">conf</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_pattern</span><span class="p">),</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
            <span class="s">&#39;int&#39;</span><span class="p">:</span>   <span class="k">lambda</span> <span class="n">conf</span><span class="p">:</span> <span class="p">(</span><span class="s">r&#39;-?\d+&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">))),</span>
            <span class="s">&#39;float&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">conf</span><span class="p">:</span> <span class="p">(</span><span class="s">r&#39;-?[\d.]+&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">))),</span>
            <span class="s">&#39;path&#39;</span><span class="p">:</span>  <span class="k">lambda</span> <span class="n">conf</span><span class="p">:</span> <span class="p">(</span><span class="s">r&#39;.+?&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">add_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Add a filter. The provided function is called with the configuration</span>
<span class="sd">        string as parameter and must return a (regexp, to_python, to_url) tuple.</span>
<span class="sd">        The first element is a string, the last two are callables or None. &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>

    <span class="n">rule_syntax</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;(</span><span class="se">\\\\</span><span class="s">*)&#39;</span>\
        <span class="s">&#39;(?:(?::([a-zA-Z_][a-zA-Z_0-9]*)?()(?:#(.*?)#)?)&#39;</span>\
          <span class="s">&#39;|(?:&lt;([a-zA-Z_][a-zA-Z_0-9]*)?(?::([a-zA-Z_]*)&#39;</span>\
            <span class="s">&#39;(?::((?:</span><span class="se">\\\\</span><span class="s">.|[^</span><span class="se">\\\\</span><span class="s">&gt;]+)+)?)?)?&gt;))&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_itertokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">):</span>
        <span class="n">offset</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_syntax</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">rule</span><span class="p">):</span>
            <span class="n">prefix</span> <span class="o">+=</span> <span class="n">rule</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()]</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">%</span><span class="mi">2</span><span class="p">:</span> <span class="c"># Escaped wildcard</span>
                <span class="n">prefix</span> <span class="o">+=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]):]</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">prefix</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">prefix</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">filtr</span><span class="p">,</span> <span class="n">conf</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="k">if</span> <span class="n">g</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">g</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">yield</span> <span class="n">name</span><span class="p">,</span> <span class="n">filtr</span> <span class="ow">or</span> <span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="n">conf</span> <span class="ow">or</span> <span class="bp">None</span>
            <span class="n">offset</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">(),</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span> <span class="ow">or</span> <span class="n">prefix</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">prefix</span><span class="o">+</span><span class="n">rule</span><span class="p">[</span><span class="n">offset</span><span class="p">:],</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Add a new rule or replace the target for an existing rule. &#39;&#39;&#39;</span>
        <span class="n">anons</span>     <span class="o">=</span> <span class="mi">0</span>    <span class="c"># Number of anonymous wildcards found</span>
        <span class="n">keys</span>      <span class="o">=</span> <span class="p">[]</span>   <span class="c"># Names of keys</span>
        <span class="n">pattern</span>   <span class="o">=</span> <span class="s">&#39;&#39;</span>   <span class="c"># Regular expression pattern with named groups</span>
        <span class="n">filters</span>   <span class="o">=</span> <span class="p">[]</span>   <span class="c"># Lists of wildcard input filters</span>
        <span class="n">builder</span>   <span class="o">=</span> <span class="p">[]</span>   <span class="c"># Data structure for the URL builder</span>
        <span class="n">is_static</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">conf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_itertokens</span><span class="p">(</span><span class="n">rule</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">mode</span><span class="p">:</span>
                <span class="n">is_static</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;default&#39;</span><span class="p">:</span> <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_filter</span>
                <span class="n">mask</span><span class="p">,</span> <span class="n">in_filter</span><span class="p">,</span> <span class="n">out_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="n">mode</span><span class="p">](</span><span class="n">conf</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">pattern</span> <span class="o">+=</span> <span class="s">&#39;(?:</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">mask</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;anon</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">anons</span>
                    <span class="n">anons</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pattern</span> <span class="o">+=</span> <span class="s">&#39;(?P&lt;</span><span class="si">%s</span><span class="s">&gt;</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
                    <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">in_filter</span><span class="p">:</span> <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">in_filter</span><span class="p">))</span>
                <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">out_filter</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">pattern</span> <span class="o">+=</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">None</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="p">[</span><span class="n">rule</span><span class="p">]</span> <span class="o">=</span> <span class="n">builder</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">builder</span>

        <span class="k">if</span> <span class="n">is_static</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">strict_order</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">static</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="p">{})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">static</span><span class="p">[</span><span class="n">method</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">rule</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">re_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;^(</span><span class="si">%s</span><span class="s">)$&#39;</span> <span class="o">%</span> <span class="n">pattern</span><span class="p">)</span>
            <span class="n">re_match</span> <span class="o">=</span> <span class="n">re_pattern</span><span class="o">.</span><span class="n">match</span>
        <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RouteSyntaxError</span><span class="p">(</span><span class="s">&quot;Could not add Route: </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">_e</span><span class="p">()))</span>

        <span class="k">if</span> <span class="n">filters</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">getargs</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">url_args</span> <span class="o">=</span> <span class="n">re_match</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">wildcard_filter</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">url_args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">wildcard_filter</span><span class="p">(</span><span class="n">url_args</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s">&#39;Path has wrong format.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">url_args</span>
        <span class="k">elif</span> <span class="n">re_pattern</span><span class="o">.</span><span class="n">groupindex</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">getargs</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">re_match</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">getargs</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">flatpat</span> <span class="o">=</span> <span class="n">_re_flatten</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
        <span class="n">whole_rule</span> <span class="o">=</span> <span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">flatpat</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">getargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">flatpat</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Route &lt;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&gt; overwrites a previously defined route&#39;</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">rule</span><span class="p">),</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dyna_routes</span><span class="p">[</span><span class="n">method</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="p">[</span><span class="n">flatpat</span><span class="p">,</span> <span class="n">method</span><span class="p">]]</span> <span class="o">=</span> <span class="n">whole_rule</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dyna_routes</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">whole_rule</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="p">[</span><span class="n">flatpat</span><span class="p">,</span> <span class="n">method</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dyna_routes</span><span class="p">[</span><span class="n">method</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_compile</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="n">all_rules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyna_routes</span><span class="p">[</span><span class="n">method</span><span class="p">]</span>
        <span class="n">comborules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyna_regexes</span><span class="p">[</span><span class="n">method</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">maxgroups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAX_GROUPS_PER_PATTERN</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_rules</span><span class="p">),</span> <span class="n">maxgroups</span><span class="p">):</span>
            <span class="n">some</span> <span class="o">=</span> <span class="n">all_rules</span><span class="p">[</span><span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">+</span><span class="n">maxgroups</span><span class="p">]</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="p">(</span><span class="n">flatpat</span> <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">flatpat</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">some</span><span class="p">)</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="s">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;(^</span><span class="si">%s</span><span class="s">$)&#39;</span> <span class="o">%</span> <span class="n">flatpat</span> <span class="k">for</span> <span class="n">flatpat</span> <span class="ow">in</span> <span class="n">combined</span><span class="p">)</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span><span class="o">.</span><span class="n">match</span>
            <span class="n">rules</span> <span class="o">=</span> <span class="p">[(</span><span class="n">target</span><span class="p">,</span> <span class="n">getargs</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">getargs</span><span class="p">)</span> <span class="ow">in</span> <span class="n">some</span><span class="p">]</span>
            <span class="n">comborules</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">combined</span><span class="p">,</span> <span class="n">rules</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_name</span><span class="p">,</span> <span class="o">*</span><span class="n">anons</span><span class="p">,</span> <span class="o">**</span><span class="n">query</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Build an URL by filling the wildcards in a rule. &#39;&#39;&#39;</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">builder</span><span class="p">:</span> <span class="k">raise</span> <span class="n">RouteBuildError</span><span class="p">(</span><span class="s">&quot;No route with that name.&quot;</span><span class="p">,</span> <span class="n">_name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">anons</span><span class="p">):</span> <span class="n">query</span><span class="p">[</span><span class="s">&#39;anon</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">f</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="k">if</span> <span class="n">n</span> <span class="k">else</span> <span class="n">f</span> <span class="k">for</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">f</span><span class="p">)</span> <span class="ow">in</span> <span class="n">builder</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">url</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span> <span class="k">else</span> <span class="n">url</span><span class="o">+</span><span class="s">&#39;?&#39;</span><span class="o">+</span><span class="n">urlencode</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RouteBuildError</span><span class="p">(</span><span class="s">&#39;Missing URL argument: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">_e</span><span class="p">()</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return a (target, url_agrs) tuple or raise HTTPError(400/404/405). &#39;&#39;&#39;</span>
        <span class="n">verb</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="s">&#39;REQUEST_METHOD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="s">&#39;PATH_INFO&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s">&#39;/&#39;</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">verb</span> <span class="o">==</span> <span class="s">&#39;HEAD&#39;</span><span class="p">:</span>
            <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;PROXY&#39;</span><span class="p">,</span> <span class="n">verb</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;ANY&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;PROXY&#39;</span><span class="p">,</span> <span class="n">verb</span><span class="p">,</span> <span class="s">&#39;ANY&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">static</span> <span class="ow">and</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">static</span><span class="p">[</span><span class="n">method</span><span class="p">]:</span>
                <span class="n">target</span><span class="p">,</span> <span class="n">getargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">static</span><span class="p">[</span><span class="n">method</span><span class="p">][</span><span class="n">path</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">target</span><span class="p">,</span> <span class="n">getargs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">getargs</span> <span class="k">else</span> <span class="p">{}</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyna_regexes</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">combined</span><span class="p">,</span> <span class="n">rules</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyna_regexes</span><span class="p">[</span><span class="n">method</span><span class="p">]:</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="n">combined</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                        <span class="n">target</span><span class="p">,</span> <span class="n">getargs</span> <span class="o">=</span> <span class="n">rules</span><span class="p">[</span><span class="n">match</span><span class="o">.</span><span class="n">lastindex</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="k">return</span> <span class="n">target</span><span class="p">,</span> <span class="n">getargs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">getargs</span> <span class="k">else</span> <span class="p">{}</span>

        <span class="c"># No matching route found. Collect alternative methods for 405 response</span>
        <span class="n">allowed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">nocheck</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">methods</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static</span><span class="p">)</span> <span class="o">-</span> <span class="n">nocheck</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">static</span><span class="p">[</span><span class="n">method</span><span class="p">]:</span>
                <span class="n">allowed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">verb</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dyna_regexes</span><span class="p">)</span> <span class="o">-</span> <span class="n">allowed</span> <span class="o">-</span> <span class="n">nocheck</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">combined</span><span class="p">,</span> <span class="n">rules</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyna_regexes</span><span class="p">[</span><span class="n">method</span><span class="p">]:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">combined</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">allowed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">allowed</span><span class="p">:</span>
            <span class="n">allow_header</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">allowed</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">405</span><span class="p">,</span> <span class="s">&quot;Method not allowed.&quot;</span><span class="p">,</span> <span class="n">Allow</span><span class="o">=</span><span class="n">allow_header</span><span class="p">)</span>

        <span class="c"># No matching route and no alternative method found. We give up</span>
        <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="s">&quot;Not found: &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>






<span class="k">class</span> <span class="nc">Route</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; This class wraps a route callback along with route specific metadata and</span>
<span class="sd">        configuration and applies Plugins on demand. It is also responsible for</span>
<span class="sd">        turing an URL path rule into a regular expression usable by the Router.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">plugins</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">skiplist</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">):</span>
        <span class="c">#: The application this route is installed to.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
        <span class="c">#: The path-rule string (e.g. ``/wiki/:page``).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rule</span> <span class="o">=</span> <span class="n">rule</span>
        <span class="c">#: The HTTP method as a string (e.g. ``GET``).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="c">#: The original callback with no plugins applied. Useful for introspection.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span>
        <span class="c">#: The name of the route (if specified) or ``None``.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="bp">None</span>
        <span class="c">#: A list of route-specific plugins (see :meth:`Bottle.route`).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span> <span class="o">=</span> <span class="n">plugins</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="c">#: A list of plugins to not apply to this route (see :meth:`Bottle.route`).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skiplist</span> <span class="o">=</span> <span class="n">skiplist</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="c">#: Additional keyword arguments passed to the :meth:`Bottle.route`</span>
        <span class="c">#: decorator are stored in this dictionary. Used for route-specific</span>
        <span class="c">#: plugin configuration and meta-data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">()</span><span class="o">.</span><span class="n">load_dict</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">make_namespaces</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">ka</span><span class="p">):</span>
        <span class="n">depr</span><span class="p">(</span><span class="s">&quot;Some APIs changed to return Route() instances instead of&quot;</span>\
             <span class="s">&quot; callables. Make sure to use the Route.call method and not to&quot;</span>\
             <span class="s">&quot; call Route instances directly.&quot;</span><span class="p">)</span> <span class="c">#0.12</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">ka</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; The route callback with all plugins applied. This property is</span>
<span class="sd">            created on demand and then cached to speed up subsequent requests.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_callback</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Forget any cached values. The next time :attr:`call` is accessed,</span>
<span class="sd">            all plugins are re-applied. &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;call&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Do all on-demand work immediately (useful for debugging).&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">depr</span><span class="p">(</span><span class="s">&#39;Switch to Plugin API v2 and access the Route object directly.&#39;</span><span class="p">)</span>  <span class="c">#0.12</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rule</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                    <span class="nb">apply</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">skiplist</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">all_plugins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Yield all Plugins affecting this route. &#39;&#39;&#39;</span>
        <span class="n">unique</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">plugins</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">True</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">skiplist</span><span class="p">:</span> <span class="k">break</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">skiplist</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">unique</span><span class="p">):</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">skiplist</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">skiplist</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">:</span> <span class="n">unique</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">_make_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span>
        <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_plugins</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="s">&#39;apply&#39;</span><span class="p">):</span>
                    <span class="n">api</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="s">&#39;api&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">api</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span>
                    <span class="n">callback</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">callback</span> <span class="o">=</span> <span class="n">plugin</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">RouteReset</span><span class="p">:</span> <span class="c"># Try again with changed configuration.</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_callback</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">callback</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">:</span>
                <span class="n">update_wrapper</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">callback</span>

    <span class="k">def</span> <span class="nf">get_undecorated_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the callback. If the callback is a decorated function, try to</span>
<span class="sd">            recover the original function. &#39;&#39;&#39;</span>
        <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s">&#39;__func__&#39;</span> <span class="k">if</span> <span class="n">py3k</span> <span class="k">else</span> <span class="s">&#39;im_func&#39;</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
        <span class="n">closure_attr</span> <span class="o">=</span> <span class="s">&#39;__closure__&#39;</span> <span class="k">if</span> <span class="n">py3k</span> <span class="k">else</span> <span class="s">&#39;func_closure&#39;</span>
        <span class="k">while</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">closure_attr</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">closure_attr</span><span class="p">):</span>
            <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">closure_attr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cell_contents</span>
        <span class="k">return</span> <span class="n">func</span>

    <span class="k">def</span> <span class="nf">get_callback_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return a list of argument names the callback (most likely) accepts</span>
<span class="sd">            as keyword arguments. If the callback is a decorated function, try</span>
<span class="sd">            to recover the original function before inspection. &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">getargspec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_undecorated_callback</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Lookup a config field and return its value, first checking the</span>
<span class="sd">            route.config, then route.app.config.&#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">conifg</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">:</span> <span class="k">return</span> <span class="n">conf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_undecorated_callback</span><span class="p">()</span>
        <span class="k">return</span> <span class="s">&#39;&lt;</span><span class="si">%s</span><span class="s"> </span><span class="si">%r</span><span class="s"> </span><span class="si">%r</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule</span><span class="p">,</span> <span class="n">cb</span><span class="p">)</span>






<span class="c">###############################################################################</span>
<span class="c"># Application Object ###########################################################</span>
<span class="c">###############################################################################</span>


<span class="k">class</span> <span class="nc">Bottle</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Each Bottle object represents a single, distinct web application and</span>
<span class="sd">        consists of routes, callbacks, plugins, resources and configuration.</span>
<span class="sd">        Instances are callable WSGI applications.</span>

<span class="sd">        :param catchall: If true (default), handle all exceptions. Turn off to</span>
<span class="sd">                         let debugging middleware handle exceptions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">catchall</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autojson</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="c">#: A :class:`ConfigDict` for app specific configuration.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">_on_change</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trigger_hook</span><span class="p">,</span> <span class="s">&#39;config&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">meta_set</span><span class="p">(</span><span class="s">&#39;autojson&#39;</span><span class="p">,</span> <span class="s">&#39;validate&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">meta_set</span><span class="p">(</span><span class="s">&#39;catchall&#39;</span><span class="p">,</span> <span class="s">&#39;validate&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;catchall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">catchall</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;autojson&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">autojson</span>

        <span class="c">#: A :class:`ResourceManager` for application files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">ResourceManager</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">routes</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># List of installed :class:`Route` instances.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">router</span> <span class="o">=</span> <span class="n">Router</span><span class="p">()</span> <span class="c"># Maps requests to :class:`Route` instances.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># Core plugins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># List of installed plugins.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;autojson&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">JSONPlugin</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">TemplatePlugin</span><span class="p">())</span>

    <span class="c">#: If true, most exceptions are caught and returned as :exc:`HTTPError`</span>
    <span class="n">catchall</span> <span class="o">=</span> <span class="n">DictProperty</span><span class="p">(</span><span class="s">&#39;config&#39;</span><span class="p">,</span> <span class="s">&#39;catchall&#39;</span><span class="p">)</span>

    <span class="n">__hook_names</span> <span class="o">=</span> <span class="s">&#39;before_request&#39;</span><span class="p">,</span> <span class="s">&#39;after_request&#39;</span><span class="p">,</span> <span class="s">&#39;app_reset&#39;</span><span class="p">,</span> <span class="s">&#39;config&#39;</span>
    <span class="n">__hook_reversed</span> <span class="o">=</span> <span class="s">&#39;after_request&#39;</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hook_names</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Attach a callback to a hook. Three hooks are currently implemented:</span>

<span class="sd">            before_request</span>
<span class="sd">                Executed once before each request. The request context is</span>
<span class="sd">                available, but no routing has happened yet.</span>
<span class="sd">            after_request</span>
<span class="sd">                Executed once after each request regardless of its outcome.</span>
<span class="sd">            app_reset</span>
<span class="sd">                Called whenever :meth:`Bottle.reset` is called.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hook_reversed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Remove a callback from a hook. &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span> <span class="ow">and</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">trigger_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Trigger a hook and return a list of results. &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">hook</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span><span class="p">[</span><span class="n">__name</span><span class="p">][:]]</span>

    <span class="k">def</span> <span class="nf">hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a decorator that attaches a callback to a hook. See</span>
<span class="sd">            :meth:`add_hook` for details.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_hook</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">decorator</span>

    <span class="k">def</span> <span class="nf">mount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Mount an application (:class:`Bottle` or plain WSGI) to a specific</span>
<span class="sd">            URL prefix. Example::</span>

<span class="sd">                root_app.mount(&#39;/admin/&#39;, admin_app)</span>

<span class="sd">            :param prefix: path prefix or `mount-point`. If it ends in a slash,</span>
<span class="sd">                that slash is mandatory.</span>
<span class="sd">            :param app: an instance of :class:`Bottle` or a WSGI application.</span>

<span class="sd">            All other parameters are passed to the underlying :meth:`route` call.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">depr</span><span class="p">(</span><span class="s">&#39;Parameter order of Bottle.mount() changed.&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span> <span class="c"># 0.10</span>

        <span class="n">segments</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prefix</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">segments</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Empty path prefix.&#39;</span><span class="p">)</span>
        <span class="n">path_depth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">mountpoint_wrapper</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">request</span><span class="o">.</span><span class="n">path_shift</span><span class="p">(</span><span class="n">path_depth</span><span class="p">)</span>
                <span class="n">rs</span> <span class="o">=</span> <span class="n">HTTPResponse</span><span class="p">([])</span>
                <span class="k">def</span> <span class="nf">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headerlist</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">exc_info</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">_raise</span><span class="p">(</span><span class="o">*</span><span class="n">exc_info</span><span class="p">)</span>
                        <span class="k">finally</span><span class="p">:</span>
                            <span class="n">exc_info</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">rs</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">headerlist</span><span class="p">:</span> <span class="n">rs</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">rs</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span>
                <span class="n">body</span> <span class="o">=</span> <span class="n">app</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">body</span> <span class="ow">and</span> <span class="n">rs</span><span class="o">.</span><span class="n">body</span><span class="p">:</span> <span class="n">body</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
                <span class="n">rs</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span> <span class="ow">or</span> <span class="n">rs</span><span class="o">.</span><span class="n">body</span>
                <span class="k">return</span> <span class="n">rs</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">request</span><span class="o">.</span><span class="n">path_shift</span><span class="p">(</span><span class="o">-</span><span class="n">path_depth</span><span class="p">)</span>

        <span class="n">options</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;skip&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">options</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;method&#39;</span><span class="p">,</span> <span class="s">&#39;PROXY&#39;</span><span class="p">)</span>
        <span class="n">options</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;mountpoint&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;prefix&#39;</span><span class="p">:</span> <span class="n">prefix</span><span class="p">,</span> <span class="s">&#39;target&#39;</span><span class="p">:</span> <span class="n">app</span><span class="p">})</span>
        <span class="n">options</span><span class="p">[</span><span class="s">&#39;callback&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mountpoint_wrapper</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s">&#39;/</span><span class="si">%s</span><span class="s">/&lt;:re:.*&gt;&#39;</span> <span class="o">%</span> <span class="s">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">segments</span><span class="p">),</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">prefix</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">segments</span><span class="p">),</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routes</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Merge the routes of another :class:`Bottle` application or a list of</span>
<span class="sd">            :class:`Route` objects into this application. The routes keep their</span>
<span class="sd">            &#39;owner&#39;, meaning that the :data:`Route.app` attribute is not</span>
<span class="sd">            changed. &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">routes</span><span class="p">,</span> <span class="n">Bottle</span><span class="p">):</span>
            <span class="n">routes</span> <span class="o">=</span> <span class="n">routes</span><span class="o">.</span><span class="n">routes</span>
        <span class="k">for</span> <span class="n">route</span> <span class="ow">in</span> <span class="n">routes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plugin</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Add a plugin to the list of plugins and prepare it for being</span>
<span class="sd">            applied to all routes of this application. A plugin may be a simple</span>
<span class="sd">            decorator or an object that implements the :class:`Plugin` API.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="s">&#39;setup&#39;</span><span class="p">):</span> <span class="n">plugin</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="s">&#39;apply&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Plugins must be callable or implement .apply()&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">plugin</span>

    <span class="k">def</span> <span class="nf">uninstall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plugin</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Uninstall plugins. Pass an instance to remove a specific plugin, a type</span>
<span class="sd">            object to remove all plugins that match that type, a string to remove</span>
<span class="sd">            all plugins with a matching ``name`` attribute or ``True`` to remove all</span>
<span class="sd">            plugins. Return the list of removed plugins. &#39;&#39;&#39;</span>
        <span class="n">removed</span><span class="p">,</span> <span class="n">remove</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plugin</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">remove</span> <span class="ow">is</span> <span class="bp">True</span> <span class="ow">or</span> <span class="n">remove</span> <span class="ow">is</span> <span class="n">plugin</span> <span class="ow">or</span> <span class="n">remove</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span> \
            <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span> <span class="o">==</span> <span class="n">remove</span><span class="p">:</span>
                <span class="n">removed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="s">&#39;close&#39;</span><span class="p">):</span> <span class="n">plugin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">removed</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">removed</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">route</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Reset all routes (force plugins to be re-applied) and clear all</span>
<span class="sd">            caches. If an ID or route object is given, only that specific route</span>
<span class="sd">            is affected. &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">route</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">routes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">routes</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">Route</span><span class="p">):</span> <span class="n">routes</span> <span class="o">=</span> <span class="p">[</span><span class="n">route</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">routes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">routes</span><span class="p">[</span><span class="n">route</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">route</span> <span class="ow">in</span> <span class="n">routes</span><span class="p">:</span> <span class="n">route</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">route</span> <span class="ow">in</span> <span class="n">routes</span><span class="p">:</span> <span class="n">route</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger_hook</span><span class="p">(</span><span class="s">&#39;app_reset&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Close the application and all installed plugins. &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="s">&#39;close&#39;</span><span class="p">):</span> <span class="n">plugin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopped</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Calls :func:`run` with the same parameters. &#39;&#39;&#39;</span>
        <span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Search for a matching route and return a (:class:`Route` , urlargs)</span>
<span class="sd">            tuple. The second value is a dictionary with parameters extracted</span>
<span class="sd">            from the URL. Raise :exc:`HTTPError` (404/405) on a non-match.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routename</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a string that matches a named route &quot;&quot;&quot;</span>
        <span class="n">scriptname</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;SCRIPT_NAME&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span>
        <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">routename</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="n">scriptname</span><span class="p">),</span> <span class="n">location</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">route</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Add a route object, but do not change the :data:`Route.app`</span>
<span class="sd">            attribute.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">route</span><span class="o">.</span><span class="n">rule</span><span class="p">,</span> <span class="n">route</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">route</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="n">route</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
              <span class="nb">apply</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A decorator to bind a function to a request URL. Example::</span>

<span class="sd">                @app.route(&#39;/hello/:name&#39;)</span>
<span class="sd">                def hello(name):</span>
<span class="sd">                    return &#39;Hello %s&#39; % name</span>

<span class="sd">            The ``:name`` part is a wildcard. See :class:`Router` for syntax</span>
<span class="sd">            details.</span>

<span class="sd">            :param path: Request path or a list of paths to listen to. If no</span>
<span class="sd">              path is specified, it is automatically generated from the</span>
<span class="sd">              signature of the function.</span>
<span class="sd">            :param method: HTTP method (`GET`, `POST`, `PUT`, ...) or a list of</span>
<span class="sd">              methods to listen to. (default: `GET`)</span>
<span class="sd">            :param callback: An optional shortcut to avoid the decorator</span>
<span class="sd">              syntax. ``route(..., callback=func)`` equals ``route(...)(func)``</span>
<span class="sd">            :param name: The name for this route. (default: None)</span>
<span class="sd">            :param apply: A decorator or plugin or a list of plugins. These are</span>
<span class="sd">              applied to the route callback in addition to installed plugins.</span>
<span class="sd">            :param skip: A list of plugins, plugin classes or names. Matching</span>
<span class="sd">              plugins are not installed to this route. ``True`` skips all.</span>

<span class="sd">            Any additional keyword arguments are stored as route-specific</span>
<span class="sd">            configuration and passed to plugins (see :meth:`Plugin.apply`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="n">path</span><span class="p">,</span> <span class="n">callback</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span>
        <span class="n">plugins</span> <span class="o">=</span> <span class="n">makelist</span><span class="p">(</span><span class="nb">apply</span><span class="p">)</span>
        <span class="n">skiplist</span> <span class="o">=</span> <span class="n">makelist</span><span class="p">(</span><span class="n">skip</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">callback</span><span class="p">):</span>
            <span class="c"># TODO: Documentation and tests</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span> <span class="n">callback</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">makelist</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">or</span> <span class="n">yieldroutes</span><span class="p">(</span><span class="n">callback</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">verb</span> <span class="ow">in</span> <span class="n">makelist</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
                    <span class="n">verb</span> <span class="o">=</span> <span class="n">verb</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                    <span class="n">route</span> <span class="o">=</span> <span class="n">Route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">verb</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                  <span class="n">plugins</span><span class="o">=</span><span class="n">plugins</span><span class="p">,</span> <span class="n">skiplist</span><span class="o">=</span><span class="n">skiplist</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">callback</span>
        <span class="k">return</span> <span class="n">decorator</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span> <span class="k">if</span> <span class="n">callback</span> <span class="k">else</span> <span class="n">decorator</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Equals :meth:`route`. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Equals :meth:`route` with a ``POST`` method parameter. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;PUT&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Equals :meth:`route` with a ``PUT`` method parameter. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;DELETE&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Equals :meth:`route` with a ``DELETE`` method parameter. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Decorator: Register an output handler for a HTTP error code&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">code</span><span class="p">)]</span> <span class="o">=</span> <span class="n">handler</span>
            <span class="k">return</span> <span class="n">handler</span>
        <span class="k">return</span> <span class="n">wrapper</span>

    <span class="k">def</span> <span class="nf">default_error_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tob</span><span class="p">(</span><span class="n">template</span><span class="p">(</span><span class="n">ERROR_PAGE_TEMPLATE</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="n">res</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="s">&#39;bottle.raw_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="s">&#39;PATH_INFO&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">py3k</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">environ</span><span class="p">[</span><span class="s">&#39;PATH_INFO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;latin1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">UnicodeError</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s">&#39;Invalid path string. Expected UTF-8&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">environ</span><span class="p">[</span><span class="s">&#39;bottle.app&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="n">request</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trigger_hook</span><span class="p">(</span><span class="s">&#39;before_request&#39;</span><span class="p">)</span>
                <span class="n">route</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>
                <span class="n">environ</span><span class="p">[</span><span class="s">&#39;route.handle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">route</span>
                <span class="n">environ</span><span class="p">[</span><span class="s">&#39;bottle.route&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">route</span>
                <span class="n">environ</span><span class="p">[</span><span class="s">&#39;route.url_args&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span>
                <span class="k">return</span> <span class="n">route</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trigger_hook</span><span class="p">(</span><span class="s">&#39;after_request&#39;</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">HTTPResponse</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_e</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">RouteReset</span><span class="p">:</span>
            <span class="n">route</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">,</span> <span class="ne">MemoryError</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">catchall</span><span class="p">:</span> <span class="k">raise</span>
            <span class="n">stacktrace</span> <span class="o">=</span> <span class="n">format_exc</span><span class="p">()</span>
            <span class="n">environ</span><span class="p">[</span><span class="s">&#39;wsgi.errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">stacktrace</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&quot;Internal Server Error&quot;</span><span class="p">,</span> <span class="n">_e</span><span class="p">(),</span> <span class="n">stacktrace</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_cast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">peek</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Try to convert the parameter into something WSGI compatible and set</span>
<span class="sd">        correct HTTP headers when possible.</span>
<span class="sd">        Support: False, str, unicode, dict, HTTPResponse, HTTPError, file-like,</span>
<span class="sd">        iterable of strings and iterable of unicodes</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Empty output is done here</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;Content-Length&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
                <span class="n">response</span><span class="p">[</span><span class="s">&#39;Content-Length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="c"># Join lists of byte or unicode strings. Mixed lists are NOT supported</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span>\
        <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="c"># b&#39;abc&#39;[0:0] -&gt; b&#39;&#39;</span>
        <span class="c"># Encode unicode strings</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">charset</span><span class="p">)</span>
        <span class="c"># Byte Strings are just returned</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">if</span> <span class="s">&#39;Content-Length&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
                <span class="n">response</span><span class="p">[</span><span class="s">&#39;Content-Length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">out</span><span class="p">]</span>
        <span class="c"># HTTPError or HTTPException (recursive, because they may wrap anything)</span>
        <span class="c"># TODO: Handle these explicitly in handle() or make them iterable.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">HTTPError</span><span class="p">):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_error_handler</span><span class="p">)(</span><span class="n">out</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cast</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">HTTPResponse</span><span class="p">):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cast</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>

        <span class="c"># File-like objects.</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="s">&#39;wsgi.file_wrapper&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;wsgi.file_wrapper&#39;</span><span class="p">](</span><span class="n">out</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&#39;close&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&#39;__iter__&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">WSGIFileWrapper</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="c"># Handle Iterables. We peek into them to detect their inner type.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">iout</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="n">first</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">iout</span><span class="p">)</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">first</span><span class="p">:</span>
                <span class="n">first</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">iout</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cast</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">HTTPResponse</span><span class="p">:</span>
            <span class="n">first</span> <span class="o">=</span> <span class="n">_e</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">,</span> <span class="ne">MemoryError</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">catchall</span><span class="p">:</span> <span class="k">raise</span>
            <span class="n">first</span> <span class="o">=</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&#39;Unhandled exception&#39;</span><span class="p">,</span> <span class="n">_e</span><span class="p">(),</span> <span class="n">format_exc</span><span class="p">())</span>

        <span class="c"># These are the inner types allowed in iterator or generator objects.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">HTTPResponse</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cast</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">new_iter</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">([</span><span class="n">first</span><span class="p">],</span> <span class="n">iout</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
            <span class="n">encoder</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">charset</span><span class="p">)</span>
            <span class="n">new_iter</span> <span class="o">=</span> <span class="n">imap</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">([</span><span class="n">first</span><span class="p">],</span> <span class="n">iout</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Unsupported response type: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cast</span><span class="p">(</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&#39;close&#39;</span><span class="p">):</span>
            <span class="n">new_iter</span> <span class="o">=</span> <span class="n">_closeiter</span><span class="p">(</span><span class="n">new_iter</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_iter</span>

    <span class="k">def</span> <span class="nf">wsgi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The bottle WSGI-interface. &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="p">(</span><span class="n">environ</span><span class="p">))</span>
            <span class="c"># rfc2616 section 4.3</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">_status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> <span class="mi">304</span><span class="p">)</span>\
            <span class="ow">or</span> <span class="n">environ</span><span class="p">[</span><span class="s">&#39;REQUEST_METHOD&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;HEAD&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&#39;close&#39;</span><span class="p">):</span> <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">start_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">_status_line</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">headerlist</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">,</span> <span class="ne">MemoryError</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">catchall</span><span class="p">:</span> <span class="k">raise</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s">&#39;&lt;h1&gt;Critical error while processing request: </span><span class="si">%s</span><span class="s">&lt;/h1&gt;&#39;</span> \
                  <span class="o">%</span> <span class="n">html_escape</span><span class="p">(</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;PATH_INFO&#39;</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">+=</span> <span class="s">&#39;&lt;h2&gt;Error:&lt;/h2&gt;</span><span class="se">\n</span><span class="s">&lt;pre&gt;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&lt;/pre&gt;</span><span class="se">\n</span><span class="s">&#39;</span> \
                       <span class="s">&#39;&lt;h2&gt;Traceback:&lt;/h2&gt;</span><span class="se">\n</span><span class="s">&lt;pre&gt;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&lt;/pre&gt;</span><span class="se">\n</span><span class="s">&#39;</span> \
                       <span class="o">%</span> <span class="p">(</span><span class="n">html_escape</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">_e</span><span class="p">())),</span> <span class="n">html_escape</span><span class="p">(</span><span class="n">format_exc</span><span class="p">()))</span>
            <span class="n">environ</span><span class="p">[</span><span class="s">&#39;wsgi.errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&#39;text/html; charset=UTF-8&#39;</span><span class="p">)]</span>
            <span class="n">start_response</span><span class="p">(</span><span class="s">&#39;500 INTERNAL SERVER ERROR&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">tob</span><span class="p">(</span><span class="n">err</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Each instance of :class:&#39;Bottle&#39; is a WSGI application. &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsgi</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>






<span class="c">###############################################################################</span>
<span class="c"># HTTP and WSGI Tools ##########################################################</span>
<span class="c">###############################################################################</span>

<span class="k">class</span> <span class="nc">BaseRequest</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A wrapper for WSGI environment dictionaries that adds a lot of</span>
<span class="sd">        convenient access methods and properties. Most of them are read-only.</span>

<span class="sd">        Adding new attributes to a request actually adds them to the environ</span>
<span class="sd">        dictionary (as &#39;bottle.request.ext.&lt;name&gt;&#39;). This is the recommended</span>
<span class="sd">        way to store and access request-specific data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;environ&#39;</span><span class="p">)</span>

    <span class="c">#: Maximum size of memory buffer for :attr:`body` in bytes.</span>
    <span class="n">MEMFILE_MAX</span> <span class="o">=</span> <span class="mi">102400</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Wrap a WSGI environ dictionary. &quot;&quot;&quot;</span>
        <span class="c">#: The wrapped WSGI environ dictionary. This is the only real attribute.</span>
        <span class="c">#: All other attributes actually are read-only properties.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environ</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">environ</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">environ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;bottle.request&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="nd">@DictProperty</span><span class="p">(</span><span class="s">&#39;environ&#39;</span><span class="p">,</span> <span class="s">&#39;bottle.app&#39;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">app</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Bottle application handling this request. &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;This request is not connected to an application.&#39;</span><span class="p">)</span>

    <span class="nd">@DictProperty</span><span class="p">(</span><span class="s">&#39;environ&#39;</span><span class="p">,</span> <span class="s">&#39;bottle.route&#39;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">route</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The bottle :class:`Route` object that matches this request. &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;This request is not connected to a route.&#39;</span><span class="p">)</span>

    <span class="nd">@DictProperty</span><span class="p">(</span><span class="s">&#39;environ&#39;</span><span class="p">,</span> <span class="s">&#39;route.url_args&#39;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">url_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The arguments extracted from the URL. &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;This request is not connected to a route.&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; The value of ``PATH_INFO`` with exactly one prefixed slash (to fix</span>
<span class="sd">            broken clients and avoid the &quot;empty path&quot; edge case). &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;PATH_INFO&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; The ``REQUEST_METHOD`` value as an uppercase string. &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;REQUEST_METHOD&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="nd">@DictProperty</span><span class="p">(</span><span class="s">&#39;environ&#39;</span><span class="p">,</span> <span class="s">&#39;bottle.request.headers&#39;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; A :class:`WSGIHeaderDict` that provides case-insensitive access to</span>
<span class="sd">            HTTP request headers. &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">WSGIHeaderDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the value of a request header, or a given default value. &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

    <span class="nd">@DictProperty</span><span class="p">(</span><span class="s">&#39;environ&#39;</span><span class="p">,</span> <span class="s">&#39;bottle.request.cookies&#39;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">cookies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Cookies parsed into a :class:`FormsDict`. Signed cookies are NOT</span>
<span class="sd">            decoded. Use :meth:`get_cookie` if you expect signed cookies. &quot;&quot;&quot;</span>
        <span class="n">cookies</span> <span class="o">=</span> <span class="n">SimpleCookie</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_COOKIE&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">FormsDict</span><span class="p">((</span><span class="n">c</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cookies</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">secret</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the content of a cookie. To read a `Signed Cookie`, the</span>
<span class="sd">            `secret` must match the one used to create the cookie (see</span>
<span class="sd">            :meth:`BaseResponse.set_cookie`). If anything goes wrong (missing</span>
<span class="sd">            cookie or wrong signature), return a default value. &quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">secret</span> <span class="ow">and</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">dec</span> <span class="o">=</span> <span class="n">cookie_decode</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">secret</span><span class="p">)</span> <span class="c"># (key, value) tuple or None</span>
            <span class="k">return</span> <span class="n">dec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">dec</span> <span class="ow">and</span> <span class="n">dec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span> <span class="k">else</span> <span class="n">default</span>
        <span class="k">return</span> <span class="n">value</span> <span class="ow">or</span> <span class="n">default</span>

    <span class="nd">@DictProperty</span><span class="p">(</span><span class="s">&#39;environ&#39;</span><span class="p">,</span> <span class="s">&#39;bottle.request.query&#39;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; The :attr:`query_string` parsed into a :class:`FormsDict`. These</span>
<span class="sd">            values are sometimes called &quot;URL arguments&quot; or &quot;GET parameters&quot;, but</span>
<span class="sd">            not to be confused with &quot;URL wildcards&quot; as they are provided by the</span>
<span class="sd">            :class:`Router`. &#39;&#39;&#39;</span>
        <span class="n">get</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;bottle.get&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FormsDict</span><span class="p">()</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="n">_parse_qsl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;QUERY_STRING&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
            <span class="n">get</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">get</span>

    <span class="nd">@DictProperty</span><span class="p">(</span><span class="s">&#39;environ&#39;</span><span class="p">,</span> <span class="s">&#39;bottle.request.forms&#39;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">forms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Form values parsed from an `url-encoded` or `multipart/form-data`</span>
<span class="sd">            encoded POST or PUT request body. The result is returned as a</span>
<span class="sd">            :class:`FormsDict`. All keys and values are strings. File uploads</span>
<span class="sd">            are stored separately in :attr:`files`. &quot;&quot;&quot;</span>
        <span class="n">forms</span> <span class="o">=</span> <span class="n">FormsDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">allitems</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">FileUpload</span><span class="p">):</span>
                <span class="n">forms</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">return</span> <span class="n">forms</span>

    <span class="nd">@DictProperty</span><span class="p">(</span><span class="s">&#39;environ&#39;</span><span class="p">,</span> <span class="s">&#39;bottle.request.params&#39;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A :class:`FormsDict` with the combined values of :attr:`query` and</span>
<span class="sd">            :attr:`forms`. File uploads are stored in :attr:`files`. &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">FormsDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">allitems</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forms</span><span class="o">.</span><span class="n">allitems</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">params</span>

    <span class="nd">@DictProperty</span><span class="p">(</span><span class="s">&#39;environ&#39;</span><span class="p">,</span> <span class="s">&#39;bottle.request.files&#39;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; File uploads parsed from `multipart/form-data` encoded POST or PUT</span>
<span class="sd">            request body. The values are instances of :class:`FileUpload`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">FormsDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">allitems</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">FileUpload</span><span class="p">):</span>
                <span class="n">files</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">return</span> <span class="n">files</span>

    <span class="nd">@DictProperty</span><span class="p">(</span><span class="s">&#39;environ&#39;</span><span class="p">,</span> <span class="s">&#39;bottle.request.json&#39;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; If the ``Content-Type`` header is ``application/json``, this</span>
<span class="sd">            property holds the parsed content of the request body. Only requests</span>
<span class="sd">            smaller than :attr:`MEMFILE_MAX` are processed to avoid memory</span>
<span class="sd">            exhaustion. &#39;&#39;&#39;</span>
        <span class="n">ctype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ctype</span> <span class="o">==</span> <span class="s">&#39;application/json&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json_loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_body_string</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_iter_body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">):</span>
        <span class="n">maxread</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_length</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">maxread</span><span class="p">:</span>
            <span class="n">part</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">maxread</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">part</span><span class="p">:</span> <span class="k">break</span>
            <span class="k">yield</span> <span class="n">part</span>
            <span class="n">maxread</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_iter_chunked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">):</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s">&#39;Error while parsing chunked transfer body.&#39;</span><span class="p">)</span>
        <span class="n">rn</span><span class="p">,</span> <span class="n">sem</span><span class="p">,</span> <span class="n">bs</span> <span class="o">=</span> <span class="n">tob</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">),</span> <span class="n">tob</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">),</span> <span class="n">tob</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">header</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">rn</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">header</span> <span class="o">+=</span> <span class="n">c</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">:</span> <span class="k">raise</span> <span class="n">err</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">bufsize</span><span class="p">:</span> <span class="k">raise</span> <span class="n">err</span>
            <span class="n">size</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">sem</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">maxread</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tonat</span><span class="p">(</span><span class="n">size</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span> <span class="mi">16</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">err</span>
            <span class="k">if</span> <span class="n">maxread</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">break</span>
            <span class="n">buff</span> <span class="o">=</span> <span class="n">bs</span>
            <span class="k">while</span> <span class="n">maxread</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">buff</span><span class="p">:</span>
                    <span class="n">buff</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">maxread</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">))</span>
                <span class="n">part</span><span class="p">,</span> <span class="n">buff</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[:</span><span class="n">maxread</span><span class="p">],</span> <span class="n">buff</span><span class="p">[</span><span class="n">maxread</span><span class="p">:]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">part</span><span class="p">:</span> <span class="k">raise</span> <span class="n">err</span>
                <span class="k">yield</span> <span class="n">part</span>
                <span class="n">maxread</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="n">rn</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">err</span>
            
    <span class="nd">@DictProperty</span><span class="p">(</span><span class="s">&#39;environ&#39;</span><span class="p">,</span> <span class="s">&#39;bottle.request.body&#39;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">body_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_chunked</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunked</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_body</span>
        <span class="n">read_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;wsgi.input&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span>
        <span class="n">body</span><span class="p">,</span> <span class="n">body_size</span><span class="p">,</span> <span class="n">is_temp_file</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">body_iter</span><span class="p">(</span><span class="n">read_func</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MEMFILE_MAX</span><span class="p">):</span>
            <span class="n">body</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
            <span class="n">body_size</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_temp_file</span> <span class="ow">and</span> <span class="n">body_size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MEMFILE_MAX</span><span class="p">:</span>
                <span class="n">body</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">TemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;w+b&#39;</span><span class="p">),</span> <span class="n">body</span>
                <span class="n">body</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
                <span class="k">del</span> <span class="n">tmp</span>
                <span class="n">is_temp_file</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;wsgi.input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">body</span>
        <span class="n">body</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">body</span>

    <span class="k">def</span> <span class="nf">_get_body_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; read body until content-length or MEMFILE_MAX into a string. Raise</span>
<span class="sd">            HTTPError(413) on requests that are to large. &#39;&#39;&#39;</span>
        <span class="n">clen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_length</span>
        <span class="k">if</span> <span class="n">clen</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MEMFILE_MAX</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">413</span><span class="p">,</span> <span class="s">&#39;Request to large&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">clen</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">clen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MEMFILE_MAX</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">clen</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MEMFILE_MAX</span><span class="p">:</span> <span class="c"># Fail fast</span>
            <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">413</span><span class="p">,</span> <span class="s">&#39;Request to large&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The HTTP request body as a seek-able file-like object. Depending on</span>
<span class="sd">            :attr:`MEMFILE_MAX`, this is either a temporary file or a</span>
<span class="sd">            :class:`io.BytesIO` instance. Accessing this property for the first</span>
<span class="sd">            time reads and replaces the ``wsgi.input`` environ variable.</span>
<span class="sd">            Subsequent accesses just do a `seek(0)` on the file object. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_body</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_body</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">chunked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; True if Chunked transfer encoding was. &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="s">&#39;chunked&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_TRANSFER_ENCODING&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c">#: An alias for :attr:`query`.</span>
    <span class="n">GET</span> <span class="o">=</span> <span class="n">query</span>

    <span class="nd">@DictProperty</span><span class="p">(</span><span class="s">&#39;environ&#39;</span><span class="p">,</span> <span class="s">&#39;bottle.request.post&#39;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The values of :attr:`forms` and :attr:`files` combined into a single</span>
<span class="sd">            :class:`FormsDict`. Values are either strings (form values) or</span>
<span class="sd">            instances of :class:`cgi.FieldStorage` (file uploads).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">post</span> <span class="o">=</span> <span class="n">FormsDict</span><span class="p">()</span>
        <span class="c"># We default to application/x-www-form-urlencoded for everything that</span>
        <span class="c"># is not multipart and take the fast path (also: 3.1 workaround)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;multipart/&#39;</span><span class="p">):</span>
            <span class="n">pairs</span> <span class="o">=</span> <span class="n">_parse_qsl</span><span class="p">(</span><span class="n">tonat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_body_string</span><span class="p">(),</span> <span class="s">&#39;latin1&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
                <span class="n">post</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">return</span> <span class="n">post</span>

        <span class="n">safe_env</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;QUERY_STRING&#39;</span><span class="p">:</span><span class="s">&#39;&#39;</span><span class="p">}</span> <span class="c"># Build a safe environment for cgi</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;REQUEST_METHOD&#39;</span><span class="p">,</span> <span class="s">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;CONTENT_LENGTH&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span> <span class="n">safe_env</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">environ</span><span class="o">=</span><span class="n">safe_env</span><span class="p">,</span> <span class="n">keep_blank_values</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">py31</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s">&#39;fp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NCTextIOWrapper</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;fp&#39;</span><span class="p">],</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf8&#39;</span><span class="p">,</span>
                                         <span class="n">newline</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">py3k</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s">&#39;encoding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;utf8&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">FieldStorage</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="s">&#39;_cgi.FieldStorage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span> <span class="c">#http://bugs.python.org/issue18394#msg207958</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">list</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">filename</span><span class="p">:</span>
                <span class="n">post</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">FileUpload</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                             <span class="n">item</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">post</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="n">post</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The full request URI including hostname and scheme. If your app</span>
<span class="sd">            lives behind a reverse proxy or load balancer and you get confusing</span>
<span class="sd">            results, make sure that the ``X-Forwarded-Host`` header is set</span>
<span class="sd">            correctly. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">urlparts</span><span class="o">.</span><span class="n">geturl</span><span class="p">()</span>

    <span class="nd">@DictProperty</span><span class="p">(</span><span class="s">&#39;environ&#39;</span><span class="p">,</span> <span class="s">&#39;bottle.request.urlparts&#39;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">urlparts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; The :attr:`url` string as an :class:`urlparse.SplitResult` tuple.</span>
<span class="sd">            The tuple contains (scheme, host, path, query_string and fragment),</span>
<span class="sd">            but the fragment is always empty because it is not visible to the</span>
<span class="sd">            server. &#39;&#39;&#39;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span>
        <span class="n">http</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_X_FORWARDED_PROTO&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;wsgi.url_scheme&#39;</span><span class="p">,</span> <span class="s">&#39;http&#39;</span><span class="p">)</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_X_FORWARDED_HOST&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_HOST&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">host</span><span class="p">:</span>
            <span class="c"># HTTP 1.1 requires a Host-header. This is for HTTP/1.0 clients.</span>
            <span class="n">host</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;SERVER_NAME&#39;</span><span class="p">,</span> <span class="s">&#39;127.0.0.1&#39;</span><span class="p">)</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;SERVER_PORT&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">port</span> <span class="ow">and</span> <span class="n">port</span> <span class="o">!=</span> <span class="p">(</span><span class="s">&#39;80&#39;</span> <span class="k">if</span> <span class="n">http</span> <span class="o">==</span> <span class="s">&#39;http&#39;</span> <span class="k">else</span> <span class="s">&#39;443&#39;</span><span class="p">):</span>
                <span class="n">host</span> <span class="o">+=</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="n">port</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">urlquote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fullpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">UrlSplitResult</span><span class="p">(</span><span class="n">http</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;QUERY_STRING&#39;</span><span class="p">),</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fullpath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Request path including :attr:`script_name` (if present). &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">script_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">query_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The raw :attr:`query` part of the URL (everything in between ``?``</span>
<span class="sd">            and ``#``) as a string. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;QUERY_STRING&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">script_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; The initial portion of the URL&#39;s `path` that was removed by a higher</span>
<span class="sd">            level (server or routing middleware) before the application was</span>
<span class="sd">            called. This script path is returned with leading and tailing</span>
<span class="sd">            slashes. &#39;&#39;&#39;</span>
        <span class="n">script_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;SCRIPT_NAME&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">script_name</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="k">if</span> <span class="n">script_name</span> <span class="k">else</span> <span class="s">&#39;/&#39;</span>

    <span class="k">def</span> <span class="nf">path_shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Shift path segments from :attr:`path` to :attr:`script_name` and</span>
<span class="sd">            vice versa.</span>

<span class="sd">           :param shift: The number of path segments to shift. May be negative</span>
<span class="sd">                         to change the shift direction. (default: 1)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">script</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;SCRIPT_NAME&#39;</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="s">&#39;SCRIPT_NAME&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s">&#39;PATH_INFO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path_shift</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">content_length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; The request body length as an integer. The client is responsible to</span>
<span class="sd">            set this header. Otherwise, the real length of the body is unknown</span>
<span class="sd">            and -1 is returned. In this case, :attr:`body` will be empty. &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;CONTENT_LENGTH&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">content_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; The Content-Type header as a lowercase-string (default: empty). &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_xhr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; True if the request was triggered by a XMLHttpRequest. This only</span>
<span class="sd">            works with JavaScript libraries that support the `X-Requested-With`</span>
<span class="sd">            header (most of the popular libraries do). &#39;&#39;&#39;</span>
        <span class="n">requested_with</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_X_REQUESTED_WITH&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">requested_with</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;xmlhttprequest&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_ajax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Alias for :attr:`is_xhr`. &quot;Ajax&quot; is not the right term. &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_xhr</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">auth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; HTTP authentication data as a (user, password) tuple. This</span>
<span class="sd">            implementation currently supports basic (not digest) authentication</span>
<span class="sd">            only. If the authentication happened at a higher level (e.g. in the</span>
<span class="sd">            front web-server or a middleware), the password field is None, but</span>
<span class="sd">            the user field is looked up from the ``REMOTE_USER`` environ</span>
<span class="sd">            variable. On any errors, None is returned. &quot;&quot;&quot;</span>
        <span class="n">basic</span> <span class="o">=</span> <span class="n">parse_auth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_AUTHORIZATION&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">basic</span><span class="p">:</span> <span class="k">return</span> <span class="n">basic</span>
        <span class="n">ruser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;REMOTE_USER&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ruser</span><span class="p">:</span> <span class="k">return</span> <span class="p">(</span><span class="n">ruser</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">remote_route</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A list of all IPs that were involved in this request, starting with</span>
<span class="sd">            the client IP and followed by zero or more proxies. This does only</span>
<span class="sd">            work if all proxies support the ```X-Forwarded-For`` header. Note</span>
<span class="sd">            that this information can be forged by malicious clients. &quot;&quot;&quot;</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_X_FORWARDED_FOR&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proxy</span><span class="p">:</span> <span class="k">return</span> <span class="p">[</span><span class="n">ip</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">proxy</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)]</span>
        <span class="n">remote</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;REMOTE_ADDR&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">remote</span><span class="p">]</span> <span class="k">if</span> <span class="n">remote</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">remote_addr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The client IP as a string. Note that this information can be forged</span>
<span class="sd">            by malicious clients. &quot;&quot;&quot;</span>
        <span class="n">route</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_route</span>
        <span class="k">return</span> <span class="n">route</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">route</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a new :class:`Request` with a shallow :attr:`environ` copy. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span> <span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Change an environ value and clear all caches that depend on it. &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;bottle.request.readonly&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;The environ dictionary is read-only.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">todelete</span> <span class="o">=</span> <span class="p">()</span>

        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;wsgi.input&#39;</span><span class="p">:</span>
            <span class="n">todelete</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">,</span> <span class="s">&#39;forms&#39;</span><span class="p">,</span> <span class="s">&#39;files&#39;</span><span class="p">,</span> <span class="s">&#39;params&#39;</span><span class="p">,</span> <span class="s">&#39;post&#39;</span><span class="p">,</span> <span class="s">&#39;json&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;QUERY_STRING&#39;</span><span class="p">:</span>
            <span class="n">todelete</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;query&#39;</span><span class="p">,</span> <span class="s">&#39;params&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;HTTP_&#39;</span><span class="p">):</span>
            <span class="n">todelete</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;headers&#39;</span><span class="p">,</span> <span class="s">&#39;cookies&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">todelete</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;bottle.request.&#39;</span><span class="o">+</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Search in self.environ for additional user defined attributes. &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;bottle.request.ext.</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">name</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">var</span><span class="o">.</span><span class="n">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">&#39;__get__&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">var</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&#39;Attribute </span><span class="si">%r</span><span class="s"> not defined.&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;environ&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="n">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;bottle.request.ext.</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>




<span class="k">def</span> <span class="nf">_hkey</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">HeaderProperty</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">reader</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="n">reader</span><span class="p">,</span> <span class="n">writer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="s">&#39;Current value of the </span><span class="si">%r</span><span class="s"> header.&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="k">else</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delete__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">del</span> <span class="n">obj</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">BaseResponse</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Storage class for a response body as well as headers and cookies.</span>

<span class="sd">        This class does support dict-like case-insensitive item-access to</span>
<span class="sd">        headers, but is NOT a dict. Most notably, iterating over a response</span>
<span class="sd">        yields parts of the body and not the headers.</span>

<span class="sd">        :param body: The response body as one of the supported types.</span>
<span class="sd">        :param status: Either an HTTP status code (e.g. 200) or a status line</span>
<span class="sd">                       including the reason phrase (e.g. &#39;200 OK&#39;).</span>
<span class="sd">        :param headers: A dictionary or a list of name-value pairs.</span>

<span class="sd">        Additional keyword arguments are added to the list of headers.</span>
<span class="sd">        Underscores in the header name are replaced with dashes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">default_status</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">default_content_type</span> <span class="o">=</span> <span class="s">&#39;text/html; charset=UTF-8&#39;</span>

    <span class="c"># Header blacklist for specific response codes</span>
    <span class="c"># (rfc2616 section 10.2.3 and 10.3.5)</span>
    <span class="n">bad_headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">204</span><span class="p">:</span> <span class="nb">set</span><span class="p">((</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,)),</span>
        <span class="mi">304</span><span class="p">:</span> <span class="nb">set</span><span class="p">((</span><span class="s">&#39;Allow&#39;</span><span class="p">,</span> <span class="s">&#39;Content-Encoding&#39;</span><span class="p">,</span> <span class="s">&#39;Content-Language&#39;</span><span class="p">,</span>
                  <span class="s">&#39;Content-Length&#39;</span><span class="p">,</span> <span class="s">&#39;Content-Range&#39;</span><span class="p">,</span> <span class="s">&#39;Content-Type&#39;</span><span class="p">,</span>
                  <span class="s">&#39;Content-Md5&#39;</span><span class="p">,</span> <span class="s">&#39;Last-Modified&#39;</span><span class="p">))}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">more_headers</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cookies</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_status</span>
        <span class="k">if</span> <span class="n">headers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">more_headers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">more_headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Returns a copy of self. &#39;&#39;&#39;</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="n">cls</span> <span class="ow">or</span> <span class="n">BaseResponse</span>
        <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">BaseResponse</span><span class="p">)</span>
        <span class="n">copy</span> <span class="o">=</span> <span class="n">cls</span><span class="p">()</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">[:])</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cookies</span><span class="p">:</span>
            <span class="n">copy</span><span class="o">.</span><span class="n">_cookies</span> <span class="o">=</span> <span class="n">SimpleCookie</span><span class="p">()</span>
            <span class="n">copy</span><span class="o">.</span><span class="n">_cookies</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cookies</span><span class="o">.</span><span class="n">output</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">copy</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="s">&#39;close&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">status_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; The HTTP status line as a string (e.g. ``404 Not Found``).&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_line</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">status_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; The HTTP status code as an integer (e.g. 404).&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span>

    <span class="k">def</span> <span class="nf">_set_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">code</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">,</span> <span class="n">_HTTP_STATUS_LINES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s">&#39; &#39;</span> <span class="ow">in</span> <span class="n">status</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">code</span>   <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;String status line without a reason phrase.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">100</span> <span class="o">&lt;=</span> <span class="n">code</span> <span class="o">&lt;=</span> <span class="mi">999</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Status code out of range.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span> <span class="o">=</span> <span class="n">code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_line</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">status</span> <span class="ow">or</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%d</span><span class="s"> Unknown&#39;</span> <span class="o">%</span> <span class="n">code</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_line</span>

    <span class="n">status</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_status</span><span class="p">,</span> <span class="n">_set_status</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
        <span class="sd">&#39;&#39;&#39; A writeable property to change the HTTP response status. It accepts</span>
<span class="sd">            either a numeric code (100-999) or a string with a custom reason</span>
<span class="sd">            phrase (e.g. &quot;404 Brain not found&quot;). Both :data:`status_line` and</span>
<span class="sd">            :data:`status_code` are updated accordingly. The return value is</span>
<span class="sd">            always a status string. &#39;&#39;&#39;</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">_get_status</span><span class="p">,</span> <span class="n">_set_status</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; An instance of :class:`HeaderDict`, a case-insensitive dict-like</span>
<span class="sd">            view on the response headers. &#39;&#39;&#39;</span>
        <span class="n">hdict</span> <span class="o">=</span> <span class="n">HeaderDict</span><span class="p">()</span>
        <span class="n">hdict</span><span class="o">.</span><span class="n">dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span>
        <span class="k">return</span> <span class="n">hdict</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span> <span class="k">return</span> <span class="n">_hkey</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span>
    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>  <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">_hkey</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">_hkey</span><span class="p">(</span><span class="n">name</span><span class="p">)][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">_hkey</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">get_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the value of a previously defined header. If there is no</span>
<span class="sd">            header with that name, return a default value. &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_hkey</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="p">[</span><span class="n">default</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">set_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Create a new response header, replacing any previously defined</span>
<span class="sd">            headers with the same name. &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">_hkey</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">add_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Add an additional response header, not removing duplicates. &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">_hkey</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">iter_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Yield (header, value) tuples, skipping headers that are not</span>
<span class="sd">            allowed with the current response status code. &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">headerlist</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">headerlist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; WSGI conform list of (header, value) tuples. &#39;&#39;&#39;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">if</span> <span class="s">&#39;Content-Type&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">:</span>
            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">default_content_type</span><span class="p">]))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_headers</span><span class="p">:</span>
            <span class="n">bad_headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_headers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span><span class="p">]</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">headers</span> <span class="k">if</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bad_headers</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">headers</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cookies</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cookies</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;Set-Cookie&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">OutputString</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="n">content_type</span> <span class="o">=</span> <span class="n">HeaderProperty</span><span class="p">(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">)</span>
    <span class="n">content_length</span> <span class="o">=</span> <span class="n">HeaderProperty</span><span class="p">(</span><span class="s">&#39;Content-Length&#39;</span><span class="p">,</span> <span class="n">reader</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">expires</span> <span class="o">=</span> <span class="n">HeaderProperty</span><span class="p">(</span><span class="s">&#39;Expires&#39;</span><span class="p">,</span>
        <span class="n">reader</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="n">parse_date</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span>
        <span class="n">writer</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">http_date</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">charset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;UTF-8&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the charset specified in the content-type header (default: utf8). &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s">&#39;charset=&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;charset=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">set_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">secret</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Create a new cookie or replace an old one. If the `secret` parameter is</span>
<span class="sd">            set, create a `Signed Cookie` (described below).</span>

<span class="sd">            :param name: the name of the cookie.</span>
<span class="sd">            :param value: the value of the cookie.</span>
<span class="sd">            :param secret: a signature key required for signed cookies.</span>

<span class="sd">            Additionally, this method accepts all RFC 2109 attributes that are</span>
<span class="sd">            supported by :class:`cookie.Morsel`, including:</span>

<span class="sd">            :param max_age: maximum age in seconds. (default: None)</span>
<span class="sd">            :param expires: a datetime object or UNIX timestamp. (default: None)</span>
<span class="sd">            :param domain: the domain that is allowed to read the cookie.</span>
<span class="sd">              (default: current domain)</span>
<span class="sd">            :param path: limits the cookie to a given path (default: current path)</span>
<span class="sd">            :param secure: limit the cookie to HTTPS connections (default: off).</span>
<span class="sd">            :param httponly: prevents client-side javascript to read this cookie</span>
<span class="sd">              (default: off, requires Python 2.6 or newer).</span>

<span class="sd">            If neither `expires` nor `max_age` is set (default), the cookie will</span>
<span class="sd">            expire at the end of the browser session (as soon as the browser</span>
<span class="sd">            window is closed).</span>

<span class="sd">            Signed cookies may store any pickle-able object and are</span>
<span class="sd">            cryptographically signed to prevent manipulation. Keep in mind that</span>
<span class="sd">            cookies are limited to 4kb in most browsers.</span>

<span class="sd">            Warning: Signed cookies are not encrypted (the client can still see</span>
<span class="sd">            the content) and not copy-protected (the client can restore an old</span>
<span class="sd">            cookie). The main intention is to make pickling and unpickling</span>
<span class="sd">            save, not to store secret information at client side.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cookies</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cookies</span> <span class="o">=</span> <span class="n">SimpleCookie</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">secret</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">touni</span><span class="p">(</span><span class="n">cookie_encode</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span> <span class="n">secret</span><span class="p">))</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Secret key missing for non-string Cookie.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Cookie value to long.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cookies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;max_age&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">seconds</span> <span class="o">+</span> <span class="n">value</span><span class="o">.</span><span class="n">days</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;expires&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">datedate</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%a, </span><span class="si">%d</span><span class="s"> %b %Y %H:%M:%S GMT&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cookies</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">delete_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Delete a cookie. Be sure to use the same `domain` and `path`</span>
<span class="sd">            settings as used to create the cookie. &#39;&#39;&#39;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;max_age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;expires&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headerlist</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">title</span><span class="p">(),</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">local_property</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span><span class="p">:</span> <span class="n">depr</span><span class="p">(</span><span class="s">&#39;local_property() is deprecated and will be removed.&#39;</span><span class="p">)</span> <span class="c">#0.12</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">fget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">return</span> <span class="n">ls</span><span class="o">.</span><span class="n">var</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Request context not initialized.&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">fset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="n">ls</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">def</span> <span class="nf">fdel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">del</span> <span class="n">ls</span><span class="o">.</span><span class="n">var</span>
    <span class="k">return</span> <span class="nb">property</span><span class="p">(</span><span class="n">fget</span><span class="p">,</span> <span class="n">fset</span><span class="p">,</span> <span class="n">fdel</span><span class="p">,</span> <span class="s">&#39;Thread-local property&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">LocalRequest</span><span class="p">(</span><span class="n">BaseRequest</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; A thread-local subclass of :class:`BaseRequest` with a different</span>
<span class="sd">        set of attributes for each thread. There is usually only one global</span>
<span class="sd">        instance of this class (:data:`request`). If accessed during a</span>
<span class="sd">        request/response cycle, this instance always refers to the *current*</span>
<span class="sd">        request (even on a multithreaded server). &#39;&#39;&#39;</span>
    <span class="n">bind</span> <span class="o">=</span> <span class="n">BaseRequest</span><span class="o">.</span><span class="n">__init__</span>
    <span class="n">environ</span> <span class="o">=</span> <span class="n">local_property</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">LocalResponse</span><span class="p">(</span><span class="n">BaseResponse</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; A thread-local subclass of :class:`BaseResponse` with a different</span>
<span class="sd">        set of attributes for each thread. There is usually only one global</span>
<span class="sd">        instance of this class (:data:`response`). Its attributes are used</span>
<span class="sd">        to build the HTTP response at the end of the request/response cycle.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">bind</span> <span class="o">=</span> <span class="n">BaseResponse</span><span class="o">.</span><span class="n">__init__</span>
    <span class="n">_status_line</span> <span class="o">=</span> <span class="n">local_property</span><span class="p">()</span>
    <span class="n">_status_code</span> <span class="o">=</span> <span class="n">local_property</span><span class="p">()</span>
    <span class="n">_cookies</span>     <span class="o">=</span> <span class="n">local_property</span><span class="p">()</span>
    <span class="n">_headers</span>     <span class="o">=</span> <span class="n">local_property</span><span class="p">()</span>
    <span class="n">body</span>         <span class="o">=</span> <span class="n">local_property</span><span class="p">()</span>


<span class="n">Request</span> <span class="o">=</span> <span class="n">BaseRequest</span>
<span class="n">Response</span> <span class="o">=</span> <span class="n">BaseResponse</span>


<span class="k">class</span> <span class="nc">HTTPResponse</span><span class="p">(</span><span class="n">Response</span><span class="p">,</span> <span class="n">BottleException</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">more_headers</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HTTPResponse</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="o">**</span><span class="n">more_headers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">response</span><span class="o">.</span><span class="n">_status_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span>
        <span class="n">response</span><span class="o">.</span><span class="n">_status_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_line</span>
        <span class="n">response</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span>
        <span class="n">response</span><span class="o">.</span><span class="n">_cookies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cookies</span>
        <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span>


<span class="k">class</span> <span class="nc">HTTPError</span><span class="p">(</span><span class="n">HTTPResponse</span><span class="p">):</span>
    <span class="n">default_status</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">traceback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="n">exception</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traceback</span> <span class="o">=</span> <span class="n">traceback</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HTTPError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>





<span class="c">###############################################################################</span>
<span class="c"># Plugins ######################################################################</span>
<span class="c">###############################################################################</span>

<span class="k">class</span> <span class="nc">PluginError</span><span class="p">(</span><span class="n">BottleException</span><span class="p">):</span> <span class="k">pass</span>


<span class="k">class</span> <span class="nc">JSONPlugin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;json&#39;</span>
    <span class="n">api</span>  <span class="o">=</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_dumps</span><span class="o">=</span><span class="n">json_dumps</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">json_dumps</span> <span class="o">=</span> <span class="n">json_dumps</span>

    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">route</span><span class="p">):</span>
        <span class="n">dumps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_dumps</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dumps</span><span class="p">:</span> <span class="k">return</span> <span class="n">callback</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">ka</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rv</span> <span class="o">=</span> <span class="n">callback</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">ka</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">HTTPError</span><span class="p">:</span>
                <span class="n">rv</span> <span class="o">=</span> <span class="n">_e</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="c">#Attempt to serialize, raises exception on failure</span>
                <span class="n">json_response</span> <span class="o">=</span> <span class="n">dumps</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span>
                <span class="c">#Set content type only if serialization succesful</span>
                <span class="n">response</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s">&#39;application/json&#39;</span>
                <span class="k">return</span> <span class="n">json_response</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">HTTPResponse</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">rv</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">dumps</span><span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
                <span class="n">rv</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s">&#39;application/json&#39;</span>
            <span class="k">return</span> <span class="n">rv</span>

        <span class="k">return</span> <span class="n">wrapper</span>


<span class="k">class</span> <span class="nc">TemplatePlugin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; This plugin applies the :func:`view` decorator to all routes with a</span>
<span class="sd">        `template` config parameter. If the parameter is a tuple, the second</span>
<span class="sd">        element must be a dict with additional options (e.g. `template_engine`)</span>
<span class="sd">        or default variables for the template. &#39;&#39;&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;template&#39;</span>
    <span class="n">api</span>  <span class="o">=</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">route</span><span class="p">):</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="n">route</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;template&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">view</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">conf</span><span class="p">[</span><span class="mi">1</span><span class="p">])(</span><span class="n">callback</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">view</span><span class="p">(</span><span class="n">conf</span><span class="p">)(</span><span class="n">callback</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">callback</span>


<span class="c">#: Not a plugin, but part of the plugin API. TODO: Find a better place.</span>
<span class="k">class</span> <span class="nc">_ImportRedirect</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">impmask</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Create a virtual package that redirects imports (see PEP 302). &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impmask</span> <span class="o">=</span> <span class="n">impmask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">imp</span><span class="o">.</span><span class="n">new_module</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;__file__&#39;</span><span class="p">:</span> <span class="n">__file__</span><span class="p">,</span> <span class="s">&#39;__path__&#39;</span><span class="p">:</span> <span class="p">[],</span>
                                    <span class="s">&#39;__all__&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s">&#39;__loader__&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="p">})</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">meta_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">find_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fullname</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">packname</span> <span class="o">=</span> <span class="n">fullname</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">packname</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">load_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fullname</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span> <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">fullname</span><span class="p">]</span>
        <span class="n">modname</span> <span class="o">=</span> <span class="n">fullname</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">realname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impmask</span> <span class="o">%</span> <span class="n">modname</span>
        <span class="nb">__import__</span><span class="p">(</span><span class="n">realname</span><span class="p">)</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">fullname</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">realname</span><span class="p">]</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">modname</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>
        <span class="n">module</span><span class="o">.</span><span class="n">__loader__</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">module</span>






<span class="c">###############################################################################</span>
<span class="c"># Common Utilities #############################################################</span>
<span class="c">###############################################################################</span>


<span class="k">class</span> <span class="nc">MultiDict</span><span class="p">(</span><span class="n">DictMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This dict stores multiple values per key, but behaves exactly like a</span>
<span class="sd">        normal dict in that it returns only the newest value for any given key.</span>
<span class="sd">        There are special methods available to access the full list of values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span> <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span>
    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span> <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">py3k</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">def</span> <span class="nf">allitems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">vl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vl</span><span class="p">)</span>
        <span class="n">iterkeys</span> <span class="o">=</span> <span class="n">keys</span>
        <span class="n">itervalues</span> <span class="o">=</span> <span class="n">values</span>
        <span class="n">iteritems</span> <span class="o">=</span> <span class="n">items</span>
        <span class="n">iterallitems</span> <span class="o">=</span> <span class="n">allitems</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="k">def</span> <span class="nf">iterkeys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">itervalues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">itervalues</span><span class="p">())</span>
        <span class="k">def</span> <span class="nf">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">())</span>
        <span class="k">def</span> <span class="nf">iterallitems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">vl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vl</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">allitems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">vl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vl</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the most recent value for a key.</span>

<span class="sd">            :param default: The default value to be returned if the key is not</span>
<span class="sd">                   present or the type conversion fails.</span>
<span class="sd">            :param index: An index for the list of available values.</span>
<span class="sd">            :param type: If defined, this callable is used to cast the value</span>
<span class="sd">                    into a specific type. Exception are suppressed and result in</span>
<span class="sd">                    the default value to be returned.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
            <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span> <span class="k">else</span> <span class="n">val</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Add a new value to the list of values for this key. &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Replace the list of values with a single value. &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">getall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return a (possibly empty) list of values for a key. &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>

    <span class="c">#: Aliases for WTForms to mimic other multi-dict APIs (Django)</span>
    <span class="n">getone</span> <span class="o">=</span> <span class="n">get</span>
    <span class="n">getlist</span> <span class="o">=</span> <span class="n">getall</span>


<span class="k">class</span> <span class="nc">FormsDict</span><span class="p">(</span><span class="n">MultiDict</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; This :class:`MultiDict` subclass is used to store request form data.</span>
<span class="sd">        Additionally to the normal dict-like item access methods (which return</span>
<span class="sd">        unmodified data as native strings), this container also supports</span>
<span class="sd">        attribute-like access to its values. Attributes are automatically de-</span>
<span class="sd">        or recoded to match :attr:`input_encoding` (default: &#39;utf8&#39;). Missing</span>
<span class="sd">        attributes default to an empty string. &#39;&#39;&#39;</span>

    <span class="c">#: Encoding used for attribute values.</span>
    <span class="n">input_encoding</span> <span class="o">=</span> <span class="s">&#39;utf8&#39;</span>
    <span class="c">#: If true (default), unicode strings are first encoded with `latin1`</span>
    <span class="c">#: and then decoded to match :attr:`input_encoding`.</span>
    <span class="n">recode_unicode</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_fix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">recode_unicode</span><span class="p">:</span> <span class="c"># Python 3 WSGI</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;latin1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_encoding</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span> <span class="c"># Python 2 WSGI</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_encoding</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Returns a copy with all keys and values de- or recoded to match</span>
<span class="sd">            :attr:`input_encoding`. Some libraries (e.g. WTForms) want a</span>
<span class="sd">            unicode dictionary. &#39;&#39;&#39;</span>
        <span class="n">copy</span> <span class="o">=</span> <span class="n">FormsDict</span><span class="p">()</span>
        <span class="n">enc</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">input_encoding</span> <span class="o">=</span> <span class="n">encoding</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_encoding</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">recode_unicode</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allitems</span><span class="p">():</span>
            <span class="n">copy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fix</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">enc</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fix</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">enc</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">copy</span>

    <span class="k">def</span> <span class="nf">getunicode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the value as a unicode string, or the default. &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fix</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">encoding</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">UnicodeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">unicode</span><span class="p">()):</span>
        <span class="c"># Without this guard, pickle generates a cryptic TypeError:</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;__&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">FormsDict</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__getattr__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getunicode</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">HeaderDict</span><span class="p">(</span><span class="n">MultiDict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A case-insensitive version of :class:`MultiDict` that defaults to</span>
<span class="sd">        replace the old value instead of appending it. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">ka</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">or</span> <span class="n">ka</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">ka</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span> <span class="k">return</span> <span class="n">_hkey</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span>
    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span> <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">_hkey</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">_hkey</span><span class="p">(</span><span class="n">key</span><span class="p">)][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">_hkey</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span>
    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">_hkey</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">_hkey</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span>
    <span class="k">def</span> <span class="nf">getall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_hkey</span><span class="p">(</span><span class="n">key</span><span class="p">))</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">MultiDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_hkey</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">default</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="n">_hkey</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">WSGIHeaderDict</span><span class="p">(</span><span class="n">DictMixin</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; This dict-like class wraps a WSGI environ dict and provides convenient</span>
<span class="sd">        access to HTTP_* fields. Keys and values are native strings</span>
<span class="sd">        (2.x bytes or 3.x unicode) and keys are case-insensitive. If the WSGI</span>
<span class="sd">        environment contains non-native string values, these are de- or encoded</span>
<span class="sd">        using a lossless &#39;latin1&#39; character set.</span>

<span class="sd">        The API will remain stable even on changes to the relevant PEPs.</span>
<span class="sd">        Currently PEP 333, 444 and 3333 are supported. (PEP 444 is the only one</span>
<span class="sd">        that uses non-native strings.)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c">#: List of keys that do not have a ``HTTP_`` prefix.</span>
    <span class="n">cgikeys</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;CONTENT_LENGTH&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environ</span> <span class="o">=</span> <span class="n">environ</span>

    <span class="k">def</span> <span class="nf">_ekey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Translate header field name to CGI/WSGI environ key. &#39;&#39;&#39;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cgikeys</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">key</span>
        <span class="k">return</span> <span class="s">&#39;HTTP_&#39;</span> <span class="o">+</span> <span class="n">key</span>

    <span class="k">def</span> <span class="nf">raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the header value as is (may be bytes or unicode). &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ekey</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">default</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tonat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ekey</span><span class="p">(</span><span class="n">key</span><span class="p">)],</span> <span class="s">&#39;latin1&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> is read-only.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> is read-only.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;HTTP_&#39;</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">key</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cgikeys</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ekey</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span>



<span class="k">class</span> <span class="nc">ConfigDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; A dict-like configuration storage with additional support for</span>
<span class="sd">        namespaces, validators, meta-data, on_change listeners and more.</span>

<span class="sd">        This storage is optimized for fast read access. Retrieving a key</span>
<span class="sd">        or using non-altering dict methods (e.g. `dict.get()`) has no overhead</span>
<span class="sd">        compared to a native dict.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;_meta&#39;</span><span class="p">,</span> <span class="s">&#39;_on_change&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Namespace</span><span class="p">(</span><span class="n">DictMixin</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">namespace</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="o">=</span> <span class="n">namespace</span>

        <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="n">depr</span><span class="p">(</span><span class="s">&#39;Accessing namespaces as dicts is discouraged. &#39;</span>
                 <span class="s">&#39;Only use flat item access: &#39;</span>
                 <span class="s">&#39;cfg[&quot;names&quot;][&quot;pace&quot;][&quot;key&quot;] -&gt; cfg[&quot;name.space.key&quot;]&#39;</span><span class="p">)</span> <span class="c">#0.12</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">ns_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">:</span>
                <span class="n">ns</span><span class="p">,</span> <span class="n">dot</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ns</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="ow">and</span> <span class="n">name</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">name</span>

        <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
        <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span>
        <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="s">&#39;&lt;Config.Namespace </span><span class="si">%s</span><span class="s">.*&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span>
        <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="s">&#39;&lt;Config.Namespace </span><span class="si">%s</span><span class="s">.*&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span>

        <span class="c"># Deprecated ConfigDict features</span>
        <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="n">depr</span><span class="p">(</span><span class="s">&#39;Attribute access is deprecated.&#39;</span><span class="p">)</span> <span class="c">#0.12</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">and</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="o">.</span><span class="n">Namespace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">and</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;__&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;_config&#39;</span><span class="p">,</span> <span class="s">&#39;_prefix&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">return</span>
            <span class="n">depr</span><span class="p">(</span><span class="s">&#39;Attribute assignment is deprecated.&#39;</span><span class="p">)</span> <span class="c">#0.12</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">DictMixin</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&#39;Read-only attribute.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&#39;Non-empty namespace attribute.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">def</span> <span class="nf">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">):</span>
                    <span class="n">prefix</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                            <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="n">key</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">ka</span><span class="p">):</span>
            <span class="n">depr</span><span class="p">(</span><span class="s">&#39;Calling ConfDict is deprecated. Use the update() method.&#39;</span><span class="p">)</span> <span class="c">#0.12</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">ka</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">ka</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_change</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">or</span> <span class="n">ka</span><span class="p">:</span>
            <span class="n">depr</span><span class="p">(</span><span class="s">&#39;Constructor does no longer accept parameters.&#39;</span><span class="p">)</span> <span class="c">#0.12</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">ka</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Load values from an *.ini style config file.</span>

<span class="sd">            If the config file contains sections, their names are used as</span>
<span class="sd">            namespaces for the values within. The two special sections</span>
<span class="sd">            ``DEFAULT`` and ``bottle`` refer to the root namespace (no prefix).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">sections</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="n">section</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">section</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;DEFAULT&#39;</span><span class="p">,</span> <span class="s">&#39;bottle&#39;</span><span class="p">):</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">section</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">key</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">load_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">make_namespaces</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Import values from a dictionary structure. Nesting can be used to</span>
<span class="sd">            represent namespaces.</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; ConfigDict().load_dict({&#39;name&#39;: {&#39;space&#39;: {&#39;key&#39;: &#39;value&#39;}}})</span>
<span class="sd">            {&#39;name.space.key&#39;: &#39;value&#39;}</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="p">[(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">source</span><span class="p">)]</span>
        <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
            <span class="n">prefix</span><span class="p">,</span> <span class="n">source</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Source is not a dict (r)&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Key is not a string (</span><span class="si">%r</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                <span class="n">full_key</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="k">if</span> <span class="n">prefix</span> <span class="k">else</span> <span class="n">key</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">full_key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">make_namespaces</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">full_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_key</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">full_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">ka</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; If the first parameter is a string, all keys are prefixed with this</span>
<span class="sd">            namespace. Apart from that it works just as the usual dict.update().</span>
<span class="sd">            Example: ``update(&#39;some.namespace&#39;, key=&#39;value&#39;)`` &#39;&#39;&#39;</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">ka</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Key has type </span><span class="si">%r</span><span class="s"> (not a string)&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&#39;filter&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_change</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="nb">dict</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="nb">dict</span><span class="o">.</span><span class="n">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">meta_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">metafield</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the value of a meta field for a key. &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metafield</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">meta_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">metafield</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Set the meta field for a key to a new value. This triggers the</span>
<span class="sd">            on-change handler for existing keys. &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{})[</span><span class="n">metafield</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">meta_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return an iterable of meta field names defined for a key. &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="c"># Deprecated ConfigDict features</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">depr</span><span class="p">(</span><span class="s">&#39;Attribute access is deprecated.&#39;</span><span class="p">)</span> <span class="c">#0.12</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">and</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">and</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;__&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__slots__</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="o">.</span><span class="n">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">depr</span><span class="p">(</span><span class="s">&#39;Attribute assignment is deprecated.&#39;</span><span class="p">)</span> <span class="c">#0.12</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&#39;Read-only attribute.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Namespace</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&#39;Non-empty namespace attribute.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Namespace</span><span class="p">):</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">ka</span><span class="p">):</span>
        <span class="n">depr</span><span class="p">(</span><span class="s">&#39;Calling ConfDict is deprecated. Use the update() method.&#39;</span><span class="p">)</span> <span class="c">#0.12</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">ka</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>



<span class="k">class</span> <span class="nc">AppStack</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A stack-like list. Calling it returns the head of the stack. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the current default application. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add a new :class:`Bottle` instance to the stack &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Bottle</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">Bottle</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">WSGIFileWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=</span><span class="mi">1024</span><span class="o">*</span><span class="mi">64</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">fp</span><span class="p">,</span> <span class="n">buffer_size</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;fileno&#39;</span><span class="p">,</span> <span class="s">&#39;close&#39;</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">,</span> <span class="s">&#39;readlines&#39;</span><span class="p">,</span> <span class="s">&#39;tell&#39;</span><span class="p">,</span> <span class="s">&#39;seek&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span> <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">buff</span><span class="p">,</span> <span class="n">read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">part</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">buff</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">part</span><span class="p">:</span> <span class="k">return</span>
            <span class="k">yield</span> <span class="n">part</span>


<span class="k">class</span> <span class="nc">_closeiter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; This only exists to be able to attach a .close method to iterators that</span>
<span class="sd">        do not support attribute assignment (most of itertools). &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterator</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterator</span> <span class="o">=</span> <span class="n">iterator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_callbacks</span> <span class="o">=</span> <span class="n">makelist</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterator</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_callbacks</span><span class="p">:</span>
            <span class="n">func</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">ResourceManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; This class manages a list of search paths and helps to find and open</span>
<span class="sd">        application-bound resources (files).</span>

<span class="sd">        :param base: default value for :meth:`add_path` calls.</span>
<span class="sd">        :param opener: callable used to open resources.</span>
<span class="sd">        :param cachemode: controls which lookups are cached. One of &#39;all&#39;,</span>
<span class="sd">                         &#39;found&#39; or &#39;none&#39;.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="s">&#39;./&#39;</span><span class="p">,</span> <span class="n">opener</span><span class="o">=</span><span class="nb">open</span><span class="p">,</span> <span class="n">cachemode</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opener</span> <span class="o">=</span> <span class="nb">open</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">base</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cachemode</span> <span class="o">=</span> <span class="n">cachemode</span>

        <span class="c">#: A list of search paths. See :meth:`add_path` for details.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c">#: A cache for resolved paths. ``res.cache.clear()`` clears the cache.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Add a new path to the list of search paths. Return False if the</span>
<span class="sd">            path does not exist.</span>

<span class="sd">            :param path: The new search path. Relative paths are turned into</span>
<span class="sd">                an absolute and normalized form. If the path looks like a file</span>
<span class="sd">                (not ending in `/`), the filename is stripped off.</span>
<span class="sd">            :param base: Path used to absolutize relative search paths.</span>
<span class="sd">                Defaults to :attr:`base` which defaults to ``os.getcwd()``.</span>
<span class="sd">            :param index: Position within the list of search paths. Defaults</span>
<span class="sd">                to last index (appends to the list).</span>

<span class="sd">            The `base` parameter makes it easy to reference files installed</span>
<span class="sd">            along with a python module or package::</span>

<span class="sd">                res.add_path(&#39;./resources/&#39;, __file__)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">base</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">))</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>
        <span class="n">path</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">create</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Iterate over all existing files in all registered paths. &#39;&#39;&#39;</span>
        <span class="n">search</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[:]</span>
        <span class="k">while</span> <span class="n">search</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="k">continue</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">full</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">full</span><span class="p">):</span> <span class="n">search</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="k">yield</span> <span class="n">full</span>

    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Search for a resource and return an absolute file path, or `None`.</span>

<span class="sd">            The :attr:`path` list is searched in order. The first match is</span>
<span class="sd">            returend. Symlinks are followed. The result is cached to speed up</span>
<span class="sd">            future lookups. &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="ow">or</span> <span class="n">DEBUG</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                <span class="n">fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cachemode</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;all&#39;</span><span class="p">,</span> <span class="s">&#39;found&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpath</span>
                    <span class="k">return</span> <span class="n">fpath</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cachemode</span> <span class="o">==</span> <span class="s">&#39;all&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Find a resource and return a file object, or raise IOError. &#39;&#39;&#39;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fname</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;Resource </span><span class="si">%r</span><span class="s"> not found.&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">opener</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FileUpload</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Wrapper for file uploads. &#39;&#39;&#39;</span>
        <span class="c">#: Open file(-like) object (BytesIO buffer or temporary file)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">fileobj</span>
        <span class="c">#: Name of the upload form field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="c">#: Raw filename as sent by the client (may contain unsafe characters)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="c">#: A :class:`HeaderDict` with additional headers (e.g. content-type)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">HeaderDict</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span> <span class="k">if</span> <span class="n">headers</span> <span class="k">else</span> <span class="n">HeaderDict</span><span class="p">()</span>

    <span class="n">content_type</span> <span class="o">=</span> <span class="n">HeaderProperty</span><span class="p">(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">)</span>
    <span class="n">content_length</span> <span class="o">=</span> <span class="n">HeaderProperty</span><span class="p">(</span><span class="s">&#39;Content-Length&#39;</span><span class="p">,</span> <span class="n">reader</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Name of the file on the client file system, but normalized to ensure</span>
<span class="sd">            file system compatibility. An empty filename is returned as &#39;empty&#39;.</span>
<span class="sd">            </span>
<span class="sd">            Only ASCII letters, digits, dashes, underscores and dots are</span>
<span class="sd">            allowed in the final filename. Accents are removed, if possible.</span>
<span class="sd">            Whitespace is replaced by a single dash. Leading or tailing dots</span>
<span class="sd">            or dashes are removed. The filename is limited to 255 characters.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_filename</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">,</span> <span class="s">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="s">&#39;NFKD&#39;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ASCII&#39;</span><span class="p">,</span> <span class="s">&#39;ignore&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;ASCII&#39;</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">))</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&#39;[^a-zA-Z0-9-_.\s]&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&#39;[-\s]+&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;.-&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fname</span><span class="p">[:</span><span class="mi">255</span><span class="p">]</span> <span class="ow">or</span> <span class="s">&#39;empty&#39;</span>

    <span class="k">def</span> <span class="nf">_copy_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">16</span><span class="p">):</span>
        <span class="n">read</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">buf</span><span class="p">:</span> <span class="k">break</span>
            <span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">16</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Save file to disk or copy its content to an open file(-like) object.</span>
<span class="sd">            If *destination* is a directory, :attr:`filename` is added to the</span>
<span class="sd">            path. Existing files are not overwritten by default (IOError).</span>

<span class="sd">            :param destination: File path, directory or file(-like) object.</span>
<span class="sd">            :param overwrite: If True, replace existing files. (default: False)</span>
<span class="sd">            :param chunk_size: Bytes to read at a time. (default: 64kb)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span> <span class="c"># Except file-likes here</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">destination</span><span class="p">):</span>
                <span class="n">destination</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">destination</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&#39;File exists.&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_copy_file</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_copy_file</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">)</span>






<span class="c">###############################################################################</span>
<span class="c"># Application Helper ###########################################################</span>
<span class="c">###############################################################################</span>


<span class="k">def</span> <span class="nf">abort</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">&#39;Unknown Error.&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Aborts execution and causes a HTTP error. &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Aborts execution and causes a 303 or 302 redirect, depending on</span>
<span class="sd">        the HTTP protocol version. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span><span class="p">:</span>
        <span class="n">code</span> <span class="o">=</span> <span class="mi">303</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;SERVER_PROTOCOL&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;HTTP/1.1&quot;</span> <span class="k">else</span> <span class="mi">302</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">cls</span><span class="o">=</span><span class="n">HTTPResponse</span><span class="p">)</span>
    <span class="n">res</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">code</span>
    <span class="n">res</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="n">res</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&#39;Location&#39;</span><span class="p">,</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">url</span><span class="p">))</span>
    <span class="k">raise</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">_file_iter_range</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">maxread</span><span class="o">=</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Yield chunks from a range in a file. No chunk is bigger than maxread.&#39;&#39;&#39;</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
    <span class="k">while</span> <span class="nb">bytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">part</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">maxread</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">part</span><span class="p">:</span> <span class="k">break</span>
        <span class="nb">bytes</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">part</span>


<span class="k">def</span> <span class="nf">static_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;auto&#39;</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s">&#39;UTF-8&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Open a file in a safe way and return :exc:`HTTPResponse` with status</span>
<span class="sd">        code 200, 305, 403 or 404. The ``Content-Type``, ``Content-Encoding``,</span>
<span class="sd">        ``Content-Length`` and ``Last-Modified`` headers are set if possible.</span>
<span class="sd">        Special support for ``If-Modified-Since``, ``Range`` and ``HEAD``</span>
<span class="sd">        requests.</span>

<span class="sd">        :param filename: Name or path of the file to send.</span>
<span class="sd">        :param root: Root path for file lookups. Should be an absolute directory</span>
<span class="sd">            path.</span>
<span class="sd">        :param mimetype: Defines the content-type header (default: guess from</span>
<span class="sd">            file extension)</span>
<span class="sd">        :param download: If True, ask the browser to open a `Save as...` dialog</span>
<span class="sd">            instead of opening the file with the associated program. You can</span>
<span class="sd">            specify a custom filename as a string. If not specified, the</span>
<span class="sd">            original filename is used (default: False).</span>
<span class="sd">        :param charset: The charset to use for files with a ``text/*``</span>
<span class="sd">            mime-type. (default: UTF-8)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">filename</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;/</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">)))</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s">&quot;Access denied.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="s">&quot;File does not exist.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s">&quot;You do not have permission to access this file.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mimetype</span> <span class="o">==</span> <span class="s">&#39;auto&#39;</span><span class="p">:</span>
        <span class="n">mimetype</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">encoding</span><span class="p">:</span> <span class="n">headers</span><span class="p">[</span><span class="s">&#39;Content-Encoding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">encoding</span>

    <span class="k">if</span> <span class="n">mimetype</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mimetype</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;text/&#39;</span> <span class="ow">and</span> <span class="n">charset</span> <span class="ow">and</span> <span class="s">&#39;charset&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mimetype</span><span class="p">:</span>
            <span class="n">mimetype</span> <span class="o">+=</span> <span class="s">&#39;; charset=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">charset</span>
        <span class="n">headers</span><span class="p">[</span><span class="s">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mimetype</span>

    <span class="k">if</span> <span class="n">download</span><span class="p">:</span>
        <span class="n">download</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span> <span class="k">if</span> <span class="n">download</span> <span class="o">==</span> <span class="bp">True</span> <span class="k">else</span> <span class="n">download</span><span class="p">)</span>
        <span class="n">headers</span><span class="p">[</span><span class="s">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;attachment; filename=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">download</span>

    <span class="n">stats</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">headers</span><span class="p">[</span><span class="s">&#39;Content-Length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clen</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">st_size</span>
    <span class="n">lm</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%a, </span><span class="si">%d</span><span class="s"> %b %Y %H:%M:%S GMT&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">))</span>
    <span class="n">headers</span><span class="p">[</span><span class="s">&#39;Last-Modified&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lm</span>

    <span class="n">ims</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_IF_MODIFIED_SINCE&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ims</span><span class="p">:</span>
        <span class="n">ims</span> <span class="o">=</span> <span class="n">parse_date</span><span class="p">(</span><span class="n">ims</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">ims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ims</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">):</span>
        <span class="n">headers</span><span class="p">[</span><span class="s">&#39;Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%a, </span><span class="si">%d</span><span class="s"> %b %Y %H:%M:%S GMT&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">HTTPResponse</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mi">304</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span>

    <span class="n">body</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;HEAD&#39;</span> <span class="k">else</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>

    <span class="n">headers</span><span class="p">[</span><span class="s">&quot;Accept-Ranges&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;bytes&quot;</span>
    <span class="n">ranges</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_RANGE&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">&#39;HTTP_RANGE&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">ranges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">parse_range_header</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;HTTP_RANGE&#39;</span><span class="p">],</span> <span class="n">clen</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ranges</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">416</span><span class="p">,</span> <span class="s">&quot;Requested Range Not Satisfiable&quot;</span><span class="p">)</span>
        <span class="n">offset</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">headers</span><span class="p">[</span><span class="s">&quot;Content-Range&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;bytes </span><span class="si">%d</span><span class="s">-</span><span class="si">%d</span><span class="s">/</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">end</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">clen</span><span class="p">)</span>
        <span class="n">headers</span><span class="p">[</span><span class="s">&quot;Content-Length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">offset</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">body</span><span class="p">:</span> <span class="n">body</span> <span class="o">=</span> <span class="n">_file_iter_range</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">end</span><span class="o">-</span><span class="n">offset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HTTPResponse</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">206</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HTTPResponse</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span>






<span class="c">###############################################################################</span>
<span class="c"># HTTP Utilities and MISC (TODO) ###############################################</span>
<span class="c">###############################################################################</span>


<span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Change the debug level.</span>
<span class="sd">    There is only one debug level supported at the moment.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">DEBUG</span>
    <span class="k">if</span> <span class="n">mode</span><span class="p">:</span> <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span>
    <span class="n">DEBUG</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">http_date</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">datedate</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">utctimetuple</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%a, </span><span class="si">%d</span><span class="s"> %b %Y %H:%M:%S GMT&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">parse_date</span><span class="p">(</span><span class="n">ims</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Parse rfc1123, rfc850 and asctime timestamps and return UTC epoch. &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">parsedate_tz</span><span class="p">(</span><span class="n">ims</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">ts</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,))</span> <span class="o">-</span> <span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">timezone</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">,</span> <span class="ne">OverflowError</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">parse_auth</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Parse rfc2617 HTTP authentication header string (basic) and return (user,pass) tuple or None&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">method</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;basic&#39;</span><span class="p">:</span>
            <span class="n">user</span><span class="p">,</span> <span class="n">pwd</span> <span class="o">=</span> <span class="n">touni</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">tob</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="n">pwd</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">parse_range_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Yield (start, end) ranges parsed from a HTTP Range header. Skip</span>
<span class="sd">        unsatisfiable ranges. The end index is non-inclusive.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">header</span> <span class="ow">or</span> <span class="n">header</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;bytes=&#39;</span><span class="p">:</span> <span class="k">return</span>
    <span class="n">ranges</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">header</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="s">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">start</span><span class="p">:</span>  <span class="c"># bytes=-100    -&gt; last 100 bytes</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">end</span><span class="p">)),</span> <span class="n">maxlen</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">end</span><span class="p">:</span>  <span class="c"># bytes=100-    -&gt; all but the first 99 bytes</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="n">maxlen</span>
            <span class="k">else</span><span class="p">:</span>          <span class="c"># bytes=100-200 -&gt; bytes 100-200 (inclusive)</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">end</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="o">&lt;=</span> <span class="n">maxlen</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="k">def</span> <span class="nf">_parse_qsl</span><span class="p">(</span><span class="n">qs</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">qs</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">,</span><span class="s">&#39;&amp;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;&amp;&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pair</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">nv</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span> <span class="n">nv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">urlunquote</span><span class="p">(</span><span class="n">nv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">))</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">urlunquote</span><span class="p">(</span><span class="n">nv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">))</span>
        <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">r</span>

<span class="k">def</span> <span class="nf">_lscmp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Compares two strings in a cryptographically safe way:</span>
<span class="sd">        Runtime is not affected by length of common prefix. &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="n">y</span> <span class="k">else</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">cookie_encode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Encode and sign a pickle-able object. Return a (byte) string &#39;&#39;&#39;</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">tob</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">msg</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">tob</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">sig</span> <span class="o">+</span> <span class="n">tob</span><span class="p">(</span><span class="s">&#39;?&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">msg</span>


<span class="k">def</span> <span class="nf">cookie_decode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Verify and decode an encoded string. Return an object or None.&#39;&#39;&#39;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">tob</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cookie_is_encoded</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">sig</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">tob</span><span class="p">(</span><span class="s">&#39;?&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_lscmp</span><span class="p">(</span><span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">tob</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">msg</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">())):</span>
            <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">None</span>


<span class="k">def</span> <span class="nf">cookie_is_encoded</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Return True if the argument looks like a encoded cookie.&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tob</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">))</span> <span class="ow">and</span> <span class="n">tob</span><span class="p">(</span><span class="s">&#39;?&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>


<div class="viewcode-block" id="html_escape"><a class="viewcode-back" href="../common.html#bottle_utils.common.html_escape">[docs]</a><span class="k">def</span> <span class="nf">html_escape</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Escape HTML special characters ``&amp;&lt;&gt;`` and quotes ``&#39;&quot;``. &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&amp;&#39;</span><span class="p">,</span><span class="s">&#39;&amp;amp;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span><span class="s">&#39;&amp;lt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&gt;&#39;</span><span class="p">,</span><span class="s">&#39;&amp;gt;&#39;</span><span class="p">)</span>\
                 <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span><span class="s">&#39;&amp;quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">,</span><span class="s">&#39;&amp;#039;&#39;</span><span class="p">)</span>

</div>
<span class="k">def</span> <span class="nf">html_quote</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Escape and quote a string to be used as an HTTP attribute.&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">html_escape</span><span class="p">(</span><span class="n">string</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;&amp;#10;&#39;</span><span class="p">)</span>\
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;&amp;#13;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;&amp;#9;&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">yieldroutes</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return a generator for routes that match the signature (name, args)</span>
<span class="sd">    of the func parameter. This may yield more than one route if the function</span>
<span class="sd">    takes optional keyword arguments. The output is best described by example::</span>

<span class="sd">        a()         -&gt; &#39;/a&#39;</span>
<span class="sd">        b(x, y)     -&gt; &#39;/b/&lt;x&gt;/&lt;y&gt;&#39;</span>
<span class="sd">        c(x, y=5)   -&gt; &#39;/c/&lt;x&gt;&#39; and &#39;/c/&lt;x&gt;/&lt;y&gt;&#39;</span>
<span class="sd">        d(x=5, y=6) -&gt; &#39;/d&#39; and &#39;/d/&lt;x&gt;&#39; and &#39;/d/&lt;x&gt;/&lt;y&gt;&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;__&#39;</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">getargspec</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="n">argc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">or</span> <span class="p">[])</span>
    <span class="n">path</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&#39;/&lt;</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">*</span> <span class="n">argc</span><span class="p">)</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="n">argc</span><span class="p">])</span>
    <span class="k">yield</span> <span class="n">path</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">argc</span><span class="p">:]:</span>
        <span class="n">path</span> <span class="o">+=</span> <span class="s">&#39;/&lt;</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="n">arg</span>
        <span class="k">yield</span> <span class="n">path</span>


<span class="k">def</span> <span class="nf">path_shift</span><span class="p">(</span><span class="n">script_name</span><span class="p">,</span> <span class="n">path_info</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Shift path fragments from PATH_INFO to SCRIPT_NAME and vice versa.</span>

<span class="sd">        :return: The modified paths.</span>
<span class="sd">        :param script_name: The SCRIPT_NAME path.</span>
<span class="sd">        :param script_name: The PATH_INFO path.</span>
<span class="sd">        :param shift: The number of path fragments to shift. May be negative to</span>
<span class="sd">          change the shift direction. (default: 1)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">shift</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">script_name</span><span class="p">,</span> <span class="n">path_info</span>
    <span class="n">pathlist</span> <span class="o">=</span> <span class="n">path_info</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
    <span class="n">scriptlist</span> <span class="o">=</span> <span class="n">script_name</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pathlist</span> <span class="ow">and</span> <span class="n">pathlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span> <span class="n">pathlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">scriptlist</span> <span class="ow">and</span> <span class="n">scriptlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span> <span class="n">scriptlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">shift</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">shift</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pathlist</span><span class="p">):</span>
        <span class="n">moved</span> <span class="o">=</span> <span class="n">pathlist</span><span class="p">[:</span><span class="n">shift</span><span class="p">]</span>
        <span class="n">scriptlist</span> <span class="o">=</span> <span class="n">scriptlist</span> <span class="o">+</span> <span class="n">moved</span>
        <span class="n">pathlist</span> <span class="o">=</span> <span class="n">pathlist</span><span class="p">[</span><span class="n">shift</span><span class="p">:]</span>
    <span class="k">elif</span> <span class="n">shift</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">shift</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">scriptlist</span><span class="p">):</span>
        <span class="n">moved</span> <span class="o">=</span> <span class="n">scriptlist</span><span class="p">[</span><span class="n">shift</span><span class="p">:]</span>
        <span class="n">pathlist</span> <span class="o">=</span> <span class="n">moved</span> <span class="o">+</span> <span class="n">pathlist</span>
        <span class="n">scriptlist</span> <span class="o">=</span> <span class="n">scriptlist</span><span class="p">[:</span><span class="n">shift</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">empty</span> <span class="o">=</span> <span class="s">&#39;SCRIPT_NAME&#39;</span> <span class="k">if</span> <span class="n">shift</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s">&#39;PATH_INFO&#39;</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&quot;Cannot shift. Nothing left from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">empty</span><span class="p">)</span>
    <span class="n">new_script_name</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scriptlist</span><span class="p">)</span>
    <span class="n">new_path_info</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pathlist</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path_info</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pathlist</span><span class="p">:</span> <span class="n">new_path_info</span> <span class="o">+=</span> <span class="s">&#39;/&#39;</span>
    <span class="k">return</span> <span class="n">new_script_name</span><span class="p">,</span> <span class="n">new_path_info</span>


<span class="k">def</span> <span class="nf">auth_basic</span><span class="p">(</span><span class="n">check</span><span class="p">,</span> <span class="n">realm</span><span class="o">=</span><span class="s">&quot;private&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">&quot;Access denied&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Callback decorator to require HTTP auth (basic).</span>
<span class="sd">        TODO: Add route(check_auth=...) parameter. &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">ka</span><span class="p">):</span>
            <span class="n">user</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">auth</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">check</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
                <span class="n">err</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s">&#39;WWW-Authenticate&#39;</span><span class="p">,</span> <span class="s">&#39;Basic realm=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">realm</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">err</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">ka</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">decorator</span>


<span class="c"># Shortcuts for common Bottle methods.</span>
<span class="c"># They all refer to the current default application.</span>

<span class="k">def</span> <span class="nf">make_default_app_wrapper</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Return a callable that relays calls to the current default app. &#39;&#39;&#39;</span>
    <span class="nd">@functools.wraps</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">Bottle</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">ka</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">app</span><span class="p">(),</span> <span class="n">name</span><span class="p">)(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">ka</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>

<span class="n">route</span>     <span class="o">=</span> <span class="n">make_default_app_wrapper</span><span class="p">(</span><span class="s">&#39;route&#39;</span><span class="p">)</span>
<span class="n">get</span>       <span class="o">=</span> <span class="n">make_default_app_wrapper</span><span class="p">(</span><span class="s">&#39;get&#39;</span><span class="p">)</span>
<span class="n">post</span>      <span class="o">=</span> <span class="n">make_default_app_wrapper</span><span class="p">(</span><span class="s">&#39;post&#39;</span><span class="p">)</span>
<span class="n">put</span>       <span class="o">=</span> <span class="n">make_default_app_wrapper</span><span class="p">(</span><span class="s">&#39;put&#39;</span><span class="p">)</span>
<span class="n">delete</span>    <span class="o">=</span> <span class="n">make_default_app_wrapper</span><span class="p">(</span><span class="s">&#39;delete&#39;</span><span class="p">)</span>
<span class="n">error</span>     <span class="o">=</span> <span class="n">make_default_app_wrapper</span><span class="p">(</span><span class="s">&#39;error&#39;</span><span class="p">)</span>
<span class="n">mount</span>     <span class="o">=</span> <span class="n">make_default_app_wrapper</span><span class="p">(</span><span class="s">&#39;mount&#39;</span><span class="p">)</span>
<span class="n">hook</span>      <span class="o">=</span> <span class="n">make_default_app_wrapper</span><span class="p">(</span><span class="s">&#39;hook&#39;</span><span class="p">)</span>
<span class="n">install</span>   <span class="o">=</span> <span class="n">make_default_app_wrapper</span><span class="p">(</span><span class="s">&#39;install&#39;</span><span class="p">)</span>
<span class="n">uninstall</span> <span class="o">=</span> <span class="n">make_default_app_wrapper</span><span class="p">(</span><span class="s">&#39;uninstall&#39;</span><span class="p">)</span>
<span class="n">url</span>       <span class="o">=</span> <span class="n">make_default_app_wrapper</span><span class="p">(</span><span class="s">&#39;get_url&#39;</span><span class="p">)</span>







<span class="c">###############################################################################</span>
<span class="c"># Server Adapter ###############################################################</span>
<span class="c">###############################################################################</span>


<span class="k">class</span> <span class="nc">ServerAdapter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">quiet</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span> <span class="c"># pragma: no cover</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CGIServer</span><span class="p">(</span><span class="n">ServerAdapter</span><span class="p">):</span>
    <span class="n">quiet</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span> <span class="c"># pragma: no cover</span>
        <span class="kn">from</span> <span class="nn">wsgiref.handlers</span> <span class="kn">import</span> <span class="n">CGIHandler</span>
        <span class="k">def</span> <span class="nf">fixed_environ</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
            <span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;PATH_INFO&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">handler</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
        <span class="n">CGIHandler</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">fixed_environ</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FlupFCGIServer</span><span class="p">(</span><span class="n">ServerAdapter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span> <span class="c"># pragma: no cover</span>
        <span class="kn">import</span> <span class="nn">flup.server.fcgi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;bindAddress&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        <span class="n">flup</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">fcgi</span><span class="o">.</span><span class="n">WSGIServer</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">WSGIRefServer</span><span class="p">(</span><span class="n">ServerAdapter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span> <span class="c"># pragma: no cover</span>
        <span class="kn">from</span> <span class="nn">wsgiref.simple_server</span> <span class="kn">import</span> <span class="n">WSGIRequestHandler</span><span class="p">,</span> <span class="n">WSGIServer</span>
        <span class="kn">from</span> <span class="nn">wsgiref.simple_server</span> <span class="kn">import</span> <span class="n">make_server</span>
        <span class="kn">import</span> <span class="nn">socket</span>

        <span class="k">class</span> <span class="nc">FixedHandler</span><span class="p">(</span><span class="n">WSGIRequestHandler</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">address_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c"># Prevent reverse DNS lookups please.</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">def</span> <span class="nf">log_request</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">WSGIRequestHandler</span><span class="o">.</span><span class="n">log_request</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

        <span class="n">handler_cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;handler_class&#39;</span><span class="p">,</span> <span class="n">FixedHandler</span><span class="p">)</span>
        <span class="n">server_cls</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;server_class&#39;</span><span class="p">,</span> <span class="n">WSGIServer</span><span class="p">)</span>

        <span class="k">if</span> <span class="s">&#39;:&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">:</span> <span class="c"># Fix wsgiref for IPv6 addresses.</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">server_cls</span><span class="p">,</span> <span class="s">&#39;address_family&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">:</span>
                <span class="k">class</span> <span class="nc">server_cls</span><span class="p">(</span><span class="n">server_cls</span><span class="p">):</span>
                    <span class="n">address_family</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET6</span>

        <span class="n">srv</span> <span class="o">=</span> <span class="n">make_server</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">server_cls</span><span class="p">,</span> <span class="n">handler_cls</span><span class="p">)</span>
        <span class="n">srv</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">CherryPyServer</span><span class="p">(</span><span class="n">ServerAdapter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span> <span class="c"># pragma: no cover</span>
        <span class="kn">from</span> <span class="nn">cherrypy</span> <span class="kn">import</span> <span class="n">wsgiserver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;bind_addr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;wsgi_app&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span>
        
        <span class="n">certfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;certfile&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">certfile</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;certfile&#39;</span><span class="p">]</span>
        <span class="n">keyfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;keyfile&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keyfile</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;keyfile&#39;</span><span class="p">]</span>
        
        <span class="n">server</span> <span class="o">=</span> <span class="n">wsgiserver</span><span class="o">.</span><span class="n">CherryPyWSGIServer</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">certfile</span><span class="p">:</span>
            <span class="n">server</span><span class="o">.</span><span class="n">ssl_certificate</span> <span class="o">=</span> <span class="n">certfile</span>
        <span class="k">if</span> <span class="n">keyfile</span><span class="p">:</span>
            <span class="n">server</span><span class="o">.</span><span class="n">ssl_private_key</span> <span class="o">=</span> <span class="n">keyfile</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">server</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">WaitressServer</span><span class="p">(</span><span class="n">ServerAdapter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">waitress</span> <span class="kn">import</span> <span class="n">serve</span>
        <span class="n">serve</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PasteServer</span><span class="p">(</span><span class="n">ServerAdapter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span> <span class="c"># pragma: no cover</span>
        <span class="kn">from</span> <span class="nn">paste</span> <span class="kn">import</span> <span class="n">httpserver</span>
        <span class="kn">from</span> <span class="nn">paste.translogger</span> <span class="kn">import</span> <span class="n">TransLogger</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">TransLogger</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">setup_console_handler</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">))</span>
        <span class="n">httpserver</span><span class="o">.</span><span class="n">serve</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">),</span>
                         <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MeinheldServer</span><span class="p">(</span><span class="n">ServerAdapter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">meinheld</span> <span class="kn">import</span> <span class="n">server</span>
        <span class="n">server</span><span class="o">.</span><span class="n">listen</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        <span class="n">server</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FapwsServer</span><span class="p">(</span><span class="n">ServerAdapter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Extremely fast webserver using libev. See http://www.fapws.org/ &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span> <span class="c"># pragma: no cover</span>
        <span class="kn">import</span> <span class="nn">fapws._evwsgi</span> <span class="kn">as</span> <span class="nn">evwsgi</span>
        <span class="kn">from</span> <span class="nn">fapws</span> <span class="kn">import</span> <span class="n">base</span><span class="p">,</span> <span class="n">config</span>
        <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span>
        <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">SERVER_IDENT</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span> <span class="o">&gt;</span> <span class="mf">0.4</span><span class="p">:</span>
            <span class="c"># fapws3 silently changed its API in 0.5</span>
            <span class="n">port</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
        <span class="n">evwsgi</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="c"># fapws3 never releases the GIL. Complain upstream. I tried. No luck.</span>
        <span class="k">if</span> <span class="s">&#39;BOTTLE_CHILD&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">_stderr</span><span class="p">(</span><span class="s">&quot;WARNING: Auto-reloading does not work with Fapws3.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">_stderr</span><span class="p">(</span><span class="s">&quot;         (Fapws3 breaks python thread support)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">evwsgi</span><span class="o">.</span><span class="n">set_base_module</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
            <span class="n">environ</span><span class="p">[</span><span class="s">&#39;wsgi.multiprocess&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">return</span> <span class="n">handler</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
        <span class="n">evwsgi</span><span class="o">.</span><span class="n">wsgi_cb</span><span class="p">((</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">app</span><span class="p">))</span>
        <span class="n">evwsgi</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">TornadoServer</span><span class="p">(</span><span class="n">ServerAdapter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; The super hyped asynchronous server by facebook. Untested. &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span> <span class="c"># pragma: no cover</span>
        <span class="kn">import</span> <span class="nn">tornado.wsgi</span><span class="o">,</span> <span class="nn">tornado.httpserver</span><span class="o">,</span> <span class="nn">tornado.ioloop</span>
        <span class="n">container</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">wsgi</span><span class="o">.</span><span class="n">WSGIContainer</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="n">server</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httpserver</span><span class="o">.</span><span class="n">HTTPServer</span><span class="p">(</span><span class="n">container</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span><span class="n">address</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>
        <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">AppEngineServer</span><span class="p">(</span><span class="n">ServerAdapter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Adapter for Google App Engine. &quot;&quot;&quot;</span>
    <span class="n">quiet</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">google.appengine.ext.webapp</span> <span class="kn">import</span> <span class="n">util</span>
        <span class="c"># A main() function in the handler script enables &#39;App Caching&#39;.</span>
        <span class="c"># Lets makes sure it is there. This _really_ improves performance.</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;__main__&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">module</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s">&#39;main&#39;</span><span class="p">):</span>
            <span class="n">module</span><span class="o">.</span><span class="n">main</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">util</span><span class="o">.</span><span class="n">run_wsgi_app</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="n">util</span><span class="o">.</span><span class="n">run_wsgi_app</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TwistedServer</span><span class="p">(</span><span class="n">ServerAdapter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Untested. &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">twisted.web</span> <span class="kn">import</span> <span class="n">server</span><span class="p">,</span> <span class="n">wsgi</span>
        <span class="kn">from</span> <span class="nn">twisted.python.threadpool</span> <span class="kn">import</span> <span class="n">ThreadPool</span>
        <span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>
        <span class="n">thread_pool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">()</span>
        <span class="n">thread_pool</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">reactor</span><span class="o">.</span><span class="n">addSystemEventTrigger</span><span class="p">(</span><span class="s">&#39;after&#39;</span><span class="p">,</span> <span class="s">&#39;shutdown&#39;</span><span class="p">,</span> <span class="n">thread_pool</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
        <span class="n">factory</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">Site</span><span class="p">(</span><span class="n">wsgi</span><span class="o">.</span><span class="n">WSGIResource</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">thread_pool</span><span class="p">,</span> <span class="n">handler</span><span class="p">))</span>
        <span class="n">reactor</span><span class="o">.</span><span class="n">listenTCP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="n">factory</span><span class="p">,</span> <span class="n">interface</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>
        <span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">DieselServer</span><span class="p">(</span><span class="n">ServerAdapter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Untested. &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">diesel.protocols.wsgi</span> <span class="kn">import</span> <span class="n">WSGIApplication</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">WSGIApplication</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
        <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">GeventServer</span><span class="p">(</span><span class="n">ServerAdapter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Untested. Options:</span>

<span class="sd">        * `fast` (default: False) uses libevent&#39;s http server, but has some</span>
<span class="sd">          issues: No streaming, no pipelining, no SSL.</span>
<span class="sd">        * See gevent.wsgi.WSGIServer() documentation for more options.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">gevent</span> <span class="kn">import</span> <span class="n">wsgi</span><span class="p">,</span> <span class="n">pywsgi</span><span class="p">,</span> <span class="n">local</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">(),</span> <span class="n">local</span><span class="o">.</span><span class="n">local</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Bottle requires gevent.monkey.patch_all() (before import)&quot;</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;fast&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span> <span class="n">wsgi</span> <span class="o">=</span> <span class="n">pywsgi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;log&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="k">else</span> <span class="s">&#39;default&#39;</span>
        <span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
        <span class="n">server</span> <span class="o">=</span> <span class="n">wsgi</span><span class="o">.</span><span class="n">WSGIServer</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;BOTTLE_CHILD&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">signal</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">server</span><span class="o">.</span><span class="n">stop</span><span class="p">())</span>
        <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">GeventSocketIOServer</span><span class="p">(</span><span class="n">ServerAdapter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">handler</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">socketio</span> <span class="kn">import</span> <span class="n">server</span>
        <span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">SocketIOServer</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">GunicornServer</span><span class="p">(</span><span class="n">ServerAdapter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Untested. See http://gunicorn.org/configure.html for options. &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">gunicorn.app.base</span> <span class="kn">import</span> <span class="n">Application</span>

        <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;bind&#39;</span><span class="p">:</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))}</span>
        <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>

        <span class="k">class</span> <span class="nc">GunicornApplication</span><span class="p">(</span><span class="n">Application</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">config</span>

            <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">handler</span>

        <span class="n">GunicornApplication</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">EventletServer</span><span class="p">(</span><span class="n">ServerAdapter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Untested &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">eventlet</span> <span class="kn">import</span> <span class="n">wsgi</span><span class="p">,</span> <span class="n">listen</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wsgi</span><span class="o">.</span><span class="n">server</span><span class="p">(</span><span class="n">listen</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)),</span> <span class="n">handler</span><span class="p">,</span>
                        <span class="n">log_output</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="c"># Fallback, if we have old version of eventlet</span>
            <span class="n">wsgi</span><span class="o">.</span><span class="n">server</span><span class="p">(</span><span class="n">listen</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)),</span> <span class="n">handler</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">RocketServer</span><span class="p">(</span><span class="n">ServerAdapter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Untested. &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">rocket</span> <span class="kn">import</span> <span class="n">Rocket</span>
        <span class="n">server</span> <span class="o">=</span> <span class="n">Rocket</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">),</span> <span class="s">&#39;wsgi&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="s">&#39;wsgi_app&#39;</span> <span class="p">:</span> <span class="n">handler</span> <span class="p">})</span>
        <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">BjoernServer</span><span class="p">(</span><span class="n">ServerAdapter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Fast server written in C: https://github.com/jonashaag/bjoern &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">bjoern</span> <span class="kn">import</span> <span class="n">run</span>
        <span class="n">run</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">AutoServer</span><span class="p">(</span><span class="n">ServerAdapter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Untested. &quot;&quot;&quot;</span>
    <span class="n">adapters</span> <span class="o">=</span> <span class="p">[</span><span class="n">WaitressServer</span><span class="p">,</span> <span class="n">PasteServer</span><span class="p">,</span> <span class="n">TwistedServer</span><span class="p">,</span> <span class="n">CherryPyServer</span><span class="p">,</span> <span class="n">WSGIRefServer</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">sa</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapters</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">sa</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="k">pass</span>

<span class="n">server_names</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;cgi&#39;</span><span class="p">:</span> <span class="n">CGIServer</span><span class="p">,</span>
    <span class="s">&#39;flup&#39;</span><span class="p">:</span> <span class="n">FlupFCGIServer</span><span class="p">,</span>
    <span class="s">&#39;wsgiref&#39;</span><span class="p">:</span> <span class="n">WSGIRefServer</span><span class="p">,</span>
    <span class="s">&#39;waitress&#39;</span><span class="p">:</span> <span class="n">WaitressServer</span><span class="p">,</span>
    <span class="s">&#39;cherrypy&#39;</span><span class="p">:</span> <span class="n">CherryPyServer</span><span class="p">,</span>
    <span class="s">&#39;paste&#39;</span><span class="p">:</span> <span class="n">PasteServer</span><span class="p">,</span>
    <span class="s">&#39;fapws3&#39;</span><span class="p">:</span> <span class="n">FapwsServer</span><span class="p">,</span>
    <span class="s">&#39;tornado&#39;</span><span class="p">:</span> <span class="n">TornadoServer</span><span class="p">,</span>
    <span class="s">&#39;gae&#39;</span><span class="p">:</span> <span class="n">AppEngineServer</span><span class="p">,</span>
    <span class="s">&#39;twisted&#39;</span><span class="p">:</span> <span class="n">TwistedServer</span><span class="p">,</span>
    <span class="s">&#39;diesel&#39;</span><span class="p">:</span> <span class="n">DieselServer</span><span class="p">,</span>
    <span class="s">&#39;meinheld&#39;</span><span class="p">:</span> <span class="n">MeinheldServer</span><span class="p">,</span>
    <span class="s">&#39;gunicorn&#39;</span><span class="p">:</span> <span class="n">GunicornServer</span><span class="p">,</span>
    <span class="s">&#39;eventlet&#39;</span><span class="p">:</span> <span class="n">EventletServer</span><span class="p">,</span>
    <span class="s">&#39;gevent&#39;</span><span class="p">:</span> <span class="n">GeventServer</span><span class="p">,</span>
    <span class="s">&#39;geventSocketIO&#39;</span><span class="p">:</span><span class="n">GeventSocketIOServer</span><span class="p">,</span>
    <span class="s">&#39;rocket&#39;</span><span class="p">:</span> <span class="n">RocketServer</span><span class="p">,</span>
    <span class="s">&#39;bjoern&#39;</span> <span class="p">:</span> <span class="n">BjoernServer</span><span class="p">,</span>
    <span class="s">&#39;auto&#39;</span><span class="p">:</span> <span class="n">AutoServer</span><span class="p">,</span>
<span class="p">}</span>






<span class="c">###############################################################################</span>
<span class="c"># Application Control ##########################################################</span>
<span class="c">###############################################################################</span>


<span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">**</span><span class="n">namespace</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Import a module or fetch an object from a module.</span>

<span class="sd">        * ``package.module`` returns `module` as a module object.</span>
<span class="sd">        * ``pack.mod:name`` returns the module variable `name` from `pack.mod`.</span>
<span class="sd">        * ``pack.mod:func()`` calls `pack.mod.func()` and returns the result.</span>

<span class="sd">        The last form accepts not only function calls, but any type of</span>
<span class="sd">        expression. Keyword arguments passed to this function are available as</span>
<span class="sd">        local variables. Example: ``import_string(&#39;re:compile(x)&#39;, x=&#39;[a-z]&#39;)``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">module</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="s">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">target</span> <span class="k">else</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">module</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span> <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">isalnum</span><span class="p">():</span> <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module</span><span class="p">],</span> <span class="n">target</span><span class="p">)</span>
    <span class="n">package_name</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">namespace</span><span class="p">[</span><span class="n">package_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">package_name</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">target</span><span class="p">),</span> <span class="n">namespace</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">load_app</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Load a bottle application from a module and make sure that the import</span>
<span class="sd">        does not affect the current default application, but returns a separate</span>
<span class="sd">        application object. See :func:`load` for the target parameter. &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">NORUN</span><span class="p">;</span> <span class="n">NORUN</span><span class="p">,</span> <span class="n">nr_old</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">NORUN</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">default_app</span><span class="o">.</span><span class="n">push</span><span class="p">()</span> <span class="c"># Create a new &quot;default application&quot;</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="c"># Import the target module</span>
        <span class="k">return</span> <span class="n">rv</span> <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="k">else</span> <span class="n">tmp</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">default_app</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="c"># Remove the temporary added default application</span>
        <span class="n">NORUN</span> <span class="o">=</span> <span class="n">nr_old</span>

<span class="n">_debug</span> <span class="o">=</span> <span class="n">debug</span>
<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="s">&#39;wsgiref&#39;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">,</span>
        <span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">reloader</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">plugins</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">debug</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Start a server instance. This method blocks until the server terminates.</span>

<span class="sd">        :param app: WSGI application or target string supported by</span>
<span class="sd">               :func:`load_app`. (default: :func:`default_app`)</span>
<span class="sd">        :param server: Server adapter to use. See :data:`server_names` keys</span>
<span class="sd">               for valid names or pass a :class:`ServerAdapter` subclass.</span>
<span class="sd">               (default: `wsgiref`)</span>
<span class="sd">        :param host: Server address to bind to. Pass ``0.0.0.0`` to listens on</span>
<span class="sd">               all interfaces including the external one. (default: 127.0.0.1)</span>
<span class="sd">        :param port: Server port to bind to. Values below 1024 require root</span>
<span class="sd">               privileges. (default: 8080)</span>
<span class="sd">        :param reloader: Start auto-reloading server? (default: False)</span>
<span class="sd">        :param interval: Auto-reloader interval in seconds (default: 1)</span>
<span class="sd">        :param quiet: Suppress output to stdout and stderr? (default: False)</span>
<span class="sd">        :param options: Options passed to the server adapter.</span>
<span class="sd">     &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">NORUN</span><span class="p">:</span> <span class="k">return</span>
    <span class="k">if</span> <span class="n">reloader</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;BOTTLE_CHILD&#39;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lockfile</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">fd</span><span class="p">,</span> <span class="n">lockfile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">&#39;bottle.&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s">&#39;.lock&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span> <span class="c"># We only need this file to exist. We never write to it</span>
            <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">lockfile</span><span class="p">):</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">]</span> <span class="o">+</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span>
                <span class="n">environ</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">environ</span><span class="p">[</span><span class="s">&#39;BOTTLE_CHILD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;true&#39;</span>
                <span class="n">environ</span><span class="p">[</span><span class="s">&#39;BOTTLE_LOCKFILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lockfile</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">environ</span><span class="p">)</span>
                <span class="k">while</span> <span class="n">p</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="c"># Busy wait...</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">lockfile</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="c"># I am alive!</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">lockfile</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">lockfile</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">poll</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">lockfile</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">lockfile</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="n">_debug</span><span class="p">(</span><span class="n">debug</span><span class="p">)</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">app</span> <span class="ow">or</span> <span class="n">default_app</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">app</span> <span class="o">=</span> <span class="n">load_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Application is not callable: </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">app</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="n">plugins</span> <span class="ow">or</span> <span class="p">[]:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">server</span> <span class="ow">in</span> <span class="n">server_names</span><span class="p">:</span>
            <span class="n">server</span> <span class="o">=</span> <span class="n">server_names</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">server</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
            <span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">ServerAdapter</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Unknown or unsupported server: </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">server</span><span class="p">)</span>

        <span class="n">server</span><span class="o">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">quiet</span> <span class="ow">or</span> <span class="n">quiet</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">server</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">_stderr</span><span class="p">(</span><span class="s">&quot;Bottle v</span><span class="si">%s</span><span class="s"> server starting up (using </span><span class="si">%s</span><span class="s">)...</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">__version__</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">server</span><span class="p">)))</span>
            <span class="n">_stderr</span><span class="p">(</span><span class="s">&quot;Listening on http://</span><span class="si">%s</span><span class="s">:</span><span class="si">%d</span><span class="s">/</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">server</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
            <span class="n">_stderr</span><span class="p">(</span><span class="s">&quot;Hit Ctrl-C to quit.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reloader</span><span class="p">:</span>
            <span class="n">lockfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;BOTTLE_LOCKFILE&#39;</span><span class="p">)</span>
            <span class="n">bgcheck</span> <span class="o">=</span> <span class="n">FileCheckerThread</span><span class="p">(</span><span class="n">lockfile</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">bgcheck</span><span class="p">:</span>
                <span class="n">server</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bgcheck</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s">&#39;reload&#39;</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">server</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">SystemExit</span><span class="p">,</span> <span class="ne">MemoryError</span><span class="p">):</span>
        <span class="k">raise</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reloader</span><span class="p">:</span> <span class="k">raise</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="s">&#39;quiet&#39;</span><span class="p">,</span> <span class="n">quiet</span><span class="p">):</span>
            <span class="n">print_exc</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">FileCheckerThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Interrupt main-thread as soon as a changed module file is detected,</span>
<span class="sd">        the lockfile gets deleted or gets to old. &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lockfile</span><span class="p">,</span> <span class="n">interval</span><span class="p">):</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lockfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">lockfile</span><span class="p">,</span> <span class="n">interval</span>
        <span class="c">#: Is one of &#39;reload&#39;, &#39;error&#39; or &#39;exit&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span>
        <span class="n">mtime</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">path</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s">&#39;__file__&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;.pyo&#39;</span><span class="p">,</span> <span class="s">&#39;.pyc&#39;</span><span class="p">):</span> <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="n">files</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtime</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lockfile</span><span class="p">)</span>\
            <span class="ow">or</span> <span class="n">mtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lockfile</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">-</span> <span class="mi">5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">&#39;error&#39;</span>
                <span class="n">thread</span><span class="o">.</span><span class="n">interrupt_main</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">lmtime</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">or</span> <span class="n">mtime</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">lmtime</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">&#39;reload&#39;</span>
                    <span class="n">thread</span><span class="o">.</span><span class="n">interrupt_main</span><span class="p">()</span>
                    <span class="k">break</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">&#39;exit&#39;</span> <span class="c"># silent exit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="ne">KeyboardInterrupt</span><span class="p">)</span>





<span class="c">###############################################################################</span>
<span class="c"># Template Adapters ############################################################</span>
<span class="c">###############################################################################</span>


<span class="k">class</span> <span class="nc">TemplateError</span><span class="p">(</span><span class="n">HTTPError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="n">HTTPError</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BaseTemplate</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Base class and minimal API for template adapters &quot;&quot;&quot;</span>
    <span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;tpl&#39;</span><span class="p">,</span><span class="s">&#39;html&#39;</span><span class="p">,</span><span class="s">&#39;thtml&#39;</span><span class="p">,</span><span class="s">&#39;stpl&#39;</span><span class="p">]</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="p">{}</span> <span class="c">#used in prepare()</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="p">{}</span> <span class="c">#used in render()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">lookup</span><span class="o">=</span><span class="p">[],</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf8&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create a new template.</span>
<span class="sd">        If the source parameter (str or buffer) is missing, the name argument</span>
<span class="sd">        is used to guess a template filename. Subclasses can assume that</span>
<span class="sd">        self.source and/or self.filename are set. Both are strings.</span>
<span class="sd">        The lookup, encoding and settings parameters are stored as instance</span>
<span class="sd">        variables.</span>
<span class="sd">        The lookup parameter stores a list containing directory paths.</span>
<span class="sd">        The encoding parameter should be used to decode byte strings or files.</span>
<span class="sd">        The settings parameter contains a dict for engine-specific settings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">filename</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s">&#39;filename&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookup</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lookup</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c"># Copy from class variable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span> <span class="c"># Apply</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TemplateError</span><span class="p">(</span><span class="s">&#39;Template </span><span class="si">%s</span><span class="s"> not found.&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TemplateError</span><span class="p">(</span><span class="s">&#39;No template specified.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">lookup</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot; Search name in all directories specified in lookup.</span>
<span class="sd">        First without, then with common extensions. Return first hit. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lookup</span><span class="p">:</span>
            <span class="n">depr</span><span class="p">(</span><span class="s">&#39;The template lookup path list should not be empty.&#39;</span><span class="p">)</span> <span class="c">#0.12</span>
            <span class="n">lookup</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;.&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="n">depr</span><span class="p">(</span><span class="s">&#39;Absolute template path names are deprecated.&#39;</span><span class="p">)</span> <span class="c">#0.12</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">spath</span> <span class="ow">in</span> <span class="n">lookup</span><span class="p">:</span>
            <span class="n">spath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">spath</span><span class="p">)</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">spath</span><span class="p">):</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span> <span class="k">return</span> <span class="n">fname</span>
            <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">extensions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">ext</span><span class="p">)):</span>
                    <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">global_config</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; This reads or sets the global settings stored in class.settings. &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c"># Make settings local to class</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Run preparations (parsing, caching, ...).</span>
<span class="sd">        It should be possible to call this again to refresh a template or to</span>
<span class="sd">        update settings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Render the template with the specified local variables and return</span>
<span class="sd">        a single byte or unicode string. If it is a byte string, the encoding</span>
<span class="sd">        must match self.encoding. This method must be thread-safe!</span>
<span class="sd">        Local variables may be provided in dictionaries (args)</span>
<span class="sd">        or directly, as keywords (kwargs).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>


<span class="k">class</span> <span class="nc">MakoTemplate</span><span class="p">(</span><span class="n">BaseTemplate</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">mako.template</span> <span class="kn">import</span> <span class="n">Template</span>
        <span class="kn">from</span> <span class="nn">mako.lookup</span> <span class="kn">import</span> <span class="n">TemplateLookup</span>
        <span class="n">options</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;input_encoding&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">})</span>
        <span class="n">options</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;format_exceptions&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">))</span>
        <span class="n">lookup</span> <span class="o">=</span> <span class="n">TemplateLookup</span><span class="p">(</span><span class="n">directories</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lookup</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tpl</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">lookup</span><span class="o">=</span><span class="n">lookup</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tpl</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">lookup</span><span class="o">=</span><span class="n">lookup</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">dictarg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dictarg</span><span class="p">)</span>
        <span class="n">_defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">_defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">_defaults</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CheetahTemplate</span><span class="p">(</span><span class="n">BaseTemplate</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">Cheetah.Template</span> <span class="kn">import</span> <span class="n">Template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">vars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">options</span><span class="p">[</span><span class="s">&#39;searchList&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">vars</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tpl</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tpl</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">dictarg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dictarg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tpl</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">out</span>


<span class="k">class</span> <span class="nc">Jinja2Template</span><span class="p">(</span><span class="n">BaseTemplate</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tests</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="nb">globals</span><span class="o">=</span><span class="p">{},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">Environment</span><span class="p">,</span> <span class="n">FunctionLoader</span>
        <span class="k">if</span> <span class="s">&#39;prefix&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="c"># TODO: to be removed after a while</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;The keyword argument `prefix` has been removed. &#39;</span>
                <span class="s">&#39;Use the full jinja2 environment name line_statement_prefix instead.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span><span class="n">loader</span><span class="o">=</span><span class="n">FunctionLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filters</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tests</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">tests</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tests</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">globals</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">globals</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tpl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tpl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">dictarg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dictarg</span><span class="p">)</span>
        <span class="n">_defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">_defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">_defaults</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">loader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fname</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SimpleTemplate</span><span class="p">(</span><span class="n">BaseTemplate</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">escape_func</span><span class="o">=</span><span class="n">html_escape</span><span class="p">,</span> <span class="n">noescape</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">syntax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">ka</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">enc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_str</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">touni</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">enc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_escape</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">escape_func</span><span class="p">(</span><span class="n">touni</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">enc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">syntax</span> <span class="o">=</span> <span class="n">syntax</span>
        <span class="k">if</span> <span class="n">noescape</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_escape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_escape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">co</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="ow">or</span> <span class="s">&#39;&lt;string&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;exec&#39;</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">source</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">source</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="n">touni</span><span class="p">(</span><span class="n">source</span><span class="p">),</span> <span class="s">&#39;utf8&#39;</span>
        <span class="k">except</span> <span class="ne">UnicodeError</span><span class="p">:</span>
            <span class="n">depr</span><span class="p">(</span><span class="s">&#39;Template encodings other than utf8 are no longer supported.&#39;</span><span class="p">)</span> <span class="c">#0.11</span>
            <span class="n">source</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="n">touni</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s">&#39;latin1&#39;</span><span class="p">),</span> <span class="s">&#39;latin1&#39;</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">StplParser</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">syntax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">syntax</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">translate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">encoding</span>
        <span class="k">return</span> <span class="n">code</span>

    <span class="k">def</span> <span class="nf">_rebase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_env</span><span class="p">,</span> <span class="n">_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">depr</span><span class="p">(</span><span class="s">&#39;Rebase function called without arguments.&#39;</span>
                 <span class="s">&#39; You were probably looking for {{base}}?&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span> <span class="c">#0.12</span>
        <span class="n">_env</span><span class="p">[</span><span class="s">&#39;_rebase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">_name</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_include</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_env</span><span class="p">,</span> <span class="n">_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">depr</span><span class="p">(</span><span class="s">&#39;Rebase function called without arguments.&#39;</span>
                 <span class="s">&#39; You were probably looking for {{base}}?&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span> <span class="c">#0.12</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">_env</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">_name</span><span class="p">,</span> <span class="n">lookup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lookup</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s">&#39;_stdout&#39;</span><span class="p">],</span> <span class="n">env</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_stdout</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;_stdout&#39;</span><span class="p">:</span> <span class="n">_stdout</span><span class="p">,</span> <span class="s">&#39;_printlist&#39;</span><span class="p">:</span> <span class="n">_stdout</span><span class="o">.</span><span class="n">extend</span><span class="p">,</span>
            <span class="s">&#39;include&#39;</span><span class="p">:</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_include</span><span class="p">,</span> <span class="n">env</span><span class="p">),</span>
            <span class="s">&#39;rebase&#39;</span><span class="p">:</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rebase</span><span class="p">,</span> <span class="n">env</span><span class="p">),</span> <span class="s">&#39;_rebase&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="s">&#39;_str&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span><span class="p">,</span> <span class="s">&#39;_escape&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_escape</span><span class="p">,</span> <span class="s">&#39;get&#39;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">,</span>
            <span class="s">&#39;setdefault&#39;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">setdefault</span><span class="p">,</span> <span class="s">&#39;defined&#39;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">__contains__</span> <span class="p">})</span>
        <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">co</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_rebase&#39;</span><span class="p">):</span>
            <span class="n">subtpl</span><span class="p">,</span> <span class="n">rargs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;_rebase&#39;</span><span class="p">)</span>
            <span class="n">rargs</span><span class="p">[</span><span class="s">&#39;base&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_stdout</span><span class="p">)</span> <span class="c">#copy stdout</span>
            <span class="k">del</span> <span class="n">_stdout</span><span class="p">[:]</span> <span class="c"># clear stdout</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">subtpl</span><span class="p">,</span> <span class="o">**</span><span class="n">rargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">env</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Render the template using keyword arguments as local variables. &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="p">{};</span> <span class="n">stdout</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dictarg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dictarg</span><span class="p">)</span>
        <span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">StplSyntaxError</span><span class="p">(</span><span class="n">TemplateError</span><span class="p">):</span> <span class="k">pass</span>


<span class="k">class</span> <span class="nc">StplParser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Parser for stpl templates. &#39;&#39;&#39;</span>
    <span class="n">_re_cache</span> <span class="o">=</span> <span class="p">{}</span> <span class="c">#: Cache for compiled re patterns</span>
    <span class="c"># This huge pile of voodoo magic splits python code into 8 different tokens.</span>
    <span class="c"># 1: All kinds of python strings (trust me, it works)</span>
    <span class="n">_re_tok</span> <span class="o">=</span> <span class="s">&#39;((?m)[urbURB]?(?:</span><span class="se">\&#39;\&#39;</span><span class="s">(?!</span><span class="se">\&#39;</span><span class="s">)|&quot;&quot;(?!&quot;)|</span><span class="se">\&#39;</span><span class="s">{6}|&quot;{6}&#39;</span> \
               <span class="s">&#39;|</span><span class="se">\&#39;</span><span class="s">(?:[^</span><span class="se">\\\\\&#39;</span><span class="s">]|</span><span class="se">\\\\</span><span class="s">.)+?</span><span class="se">\&#39;</span><span class="s">|&quot;(?:[^</span><span class="se">\\\\</span><span class="s">&quot;]|</span><span class="se">\\\\</span><span class="s">.)+?&quot;&#39;</span> \
               <span class="s">&#39;|</span><span class="se">\&#39;</span><span class="s">{3}(?:[^</span><span class="se">\\\\</span><span class="s">]|</span><span class="se">\\\\</span><span class="s">.|</span><span class="se">\\</span><span class="s">n)+?</span><span class="se">\&#39;</span><span class="s">{3}&#39;</span> \
               <span class="s">&#39;|&quot;{3}(?:[^</span><span class="se">\\\\</span><span class="s">]|</span><span class="se">\\\\</span><span class="s">.|</span><span class="se">\\</span><span class="s">n)+?&quot;{3}))&#39;</span>
    <span class="n">_re_inl</span> <span class="o">=</span> <span class="n">_re_tok</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;|</span><span class="se">\\</span><span class="s">n&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span> <span class="c"># We re-use this string pattern later</span>
    <span class="c"># 2: Comments (until end of line, but not the newline itself)</span>
    <span class="n">_re_tok</span> <span class="o">+=</span> <span class="s">&#39;|(#.*)&#39;</span>
    <span class="c"># 3,4: Keywords that start or continue a python block (only start of line)</span>
    <span class="n">_re_tok</span> <span class="o">+=</span> <span class="s">&#39;|^([ </span><span class="se">\\</span><span class="s">t]*(?:if|for|while|with|try|def|class)</span><span class="se">\\</span><span class="s">b)&#39;</span> \
               <span class="s">&#39;|^([ </span><span class="se">\\</span><span class="s">t]*(?:elif|else|except|finally)</span><span class="se">\\</span><span class="s">b)&#39;</span>
    <span class="c"># 5: Our special &#39;end&#39; keyword (but only if it stands alone)</span>
    <span class="n">_re_tok</span> <span class="o">+=</span> <span class="s">&#39;|((?:^|;)[ </span><span class="se">\\</span><span class="s">t]*end[ </span><span class="se">\\</span><span class="s">t]*(?=(?:</span><span class="si">%(block_close)s</span><span class="s">[ </span><span class="se">\\</span><span class="s">t]*)?</span><span class="se">\\</span><span class="s">r?$|;|#))&#39;</span>
    <span class="c"># 6: A customizable end-of-code-block template token (only end of line)</span>
    <span class="n">_re_tok</span> <span class="o">+=</span> <span class="s">&#39;|(</span><span class="si">%(block_close)s</span><span class="s">[ </span><span class="se">\\</span><span class="s">t]*(?=$))&#39;</span>
    <span class="c"># 7: And finally, a single newline. The 8th token is &#39;everything else&#39;</span>
    <span class="n">_re_tok</span> <span class="o">+=</span> <span class="s">&#39;|(</span><span class="se">\\</span><span class="s">r?</span><span class="se">\\</span><span class="s">n)&#39;</span>
    <span class="c"># Match the start tokens of code areas in a template</span>
    <span class="n">_re_split</span> <span class="o">=</span> <span class="s">&#39;(?m)^[ </span><span class="se">\t</span><span class="s">]*(</span><span class="se">\\\\</span><span class="s">?)((</span><span class="si">%(line_start)s</span><span class="s">)|(</span><span class="si">%(block_start)s</span><span class="s">))(</span><span class="si">%%</span><span class="s">?)&#39;</span>
    <span class="c"># Match inline statements (may contain python strings)</span>
    <span class="n">_re_inl</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%%</span><span class="s">(inline_start)s((?:</span><span class="si">%s</span><span class="s">|[^</span><span class="se">\&#39;</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">]*?)+)</span><span class="si">%%</span><span class="s">(inline_end)s&#39;</span> <span class="o">%</span> <span class="n">_re_inl</span>

    <span class="n">default_syntax</span> <span class="o">=</span> <span class="s">&#39;&lt;</span><span class="si">% %</span><span class="s">&gt; % {{ }}&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">syntax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf8&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">touni</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">encoding</span><span class="p">),</span> <span class="n">encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_syntax</span><span class="p">(</span><span class="n">syntax</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_syntax</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code_buffer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_buffer</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indent_mod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">get_syntax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Tokens as a space separated string (default: &lt;% %&gt; % {{ }}) &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_syntax</span>

    <span class="k">def</span> <span class="nf">set_syntax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">syntax</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_syntax</span> <span class="o">=</span> <span class="n">syntax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tokens</span> <span class="o">=</span> <span class="n">syntax</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">syntax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_re_cache</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="s">&#39;block_start block_close line_start inline_start inline_end&#39;</span>
            <span class="n">etokens</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokens</span><span class="p">)</span>
            <span class="n">pattern_vars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="n">etokens</span><span class="p">))</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_re_split</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_re_tok</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_re_inl</span><span class="p">)</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">p</span><span class="o">%</span><span class="n">pattern_vars</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_re_cache</span><span class="p">[</span><span class="n">syntax</span><span class="p">]</span> <span class="o">=</span> <span class="n">patterns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">re_split</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_tok</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_inl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_re_cache</span><span class="p">[</span><span class="n">syntax</span><span class="p">]</span>

    <span class="n">syntax</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_syntax</span><span class="p">,</span> <span class="n">set_syntax</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">translate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Parser is a one time instance.&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_split</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">:])</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="o">+</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">text_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+=</span> <span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span> <span class="c"># New escape syntax</span>
                    <span class="n">line</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">:]</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">text_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="n">line</span><span class="o">+</span><span class="n">sep</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">+</span><span class="n">sep</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span> <span class="c"># Old escape syntax</span>
                    <span class="n">depr</span><span class="p">(</span><span class="s">&#39;Escape code lines with a backslash.&#39;</span><span class="p">)</span> <span class="c">#0.12</span>
                    <span class="n">line</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">:]</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">text_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">line</span><span class="o">+</span><span class="n">sep</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">+</span><span class="n">sep</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flush_text</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_code</span><span class="p">(</span><span class="n">multiline</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush_text</span><span class="p">()</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code_buffer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiline</span><span class="p">):</span>
        <span class="n">code_line</span><span class="p">,</span> <span class="n">comment</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_tok</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">:])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">code_line</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">:]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_code</span><span class="p">(</span><span class="n">code_line</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">comment</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">code_line</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="o">+</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+=</span> <span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
            <span class="n">_str</span><span class="p">,</span> <span class="n">_com</span><span class="p">,</span> <span class="n">_blk1</span><span class="p">,</span> <span class="n">_blk2</span><span class="p">,</span> <span class="n">_end</span><span class="p">,</span> <span class="n">_cend</span><span class="p">,</span> <span class="n">_nl</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">code_line</span> <span class="ow">and</span> <span class="p">(</span><span class="n">_blk1</span> <span class="ow">or</span> <span class="n">_blk2</span><span class="p">):</span> <span class="c"># a if b else c</span>
                <span class="n">code_line</span> <span class="o">+=</span> <span class="n">_blk1</span> <span class="ow">or</span> <span class="n">_blk2</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">_str</span><span class="p">:</span>    <span class="c"># Python string</span>
                <span class="n">code_line</span> <span class="o">+=</span> <span class="n">_str</span>
            <span class="k">elif</span> <span class="n">_com</span><span class="p">:</span>  <span class="c"># Python comment (up to EOL)</span>
                <span class="n">comment</span> <span class="o">=</span> <span class="n">_com</span>
                <span class="k">if</span> <span class="n">multiline</span> <span class="ow">and</span> <span class="n">_com</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">multiline</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># Allow end-of-block in comments</span>
            <span class="k">elif</span> <span class="n">_blk1</span><span class="p">:</span> <span class="c"># Start-block keyword (if/for/while/def/try/...)</span>
                <span class="n">code_line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indent_mod</span> <span class="o">=</span> <span class="n">_blk1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indent</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">_blk2</span><span class="p">:</span> <span class="c"># Continue-block keyword (else/elif/except/...)</span>
                <span class="n">code_line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indent_mod</span> <span class="o">=</span> <span class="n">_blk2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">elif</span> <span class="n">_end</span><span class="p">:</span>  <span class="c"># The non-standard &#39;end&#39;-keyword (ends a block)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indent</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">_cend</span><span class="p">:</span> <span class="c"># The end-code-block template token (usually &#39;%&gt;&#39;)</span>
                <span class="k">if</span> <span class="n">multiline</span><span class="p">:</span> <span class="n">multiline</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">code_line</span> <span class="o">+=</span> <span class="n">_cend</span>
            <span class="k">else</span><span class="p">:</span> <span class="c"># \n</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_code</span><span class="p">(</span><span class="n">code_line</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">comment</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lineno</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">code_line</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indent_mod</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">multiline</span><span class="p">:</span>
                    <span class="k">break</span>

    <span class="k">def</span> <span class="nf">flush_text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text_buffer</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_buffer</span><span class="p">[:]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">parts</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">nl</span> <span class="o">=</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\\\n</span><span class="s">&#39;</span><span class="o">+</span><span class="s">&#39;  &#39;</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">indent</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_inl</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="n">prefix</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">pos</span><span class="p">:</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()],</span> <span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">prefix</span><span class="p">:</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nl</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="n">prefix</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="bp">True</span><span class="p">))))</span>
            <span class="k">if</span> <span class="n">prefix</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">):</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">nl</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_inline</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">pos</span><span class="p">:]</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\\\\n</span><span class="s">&#39;</span><span class="p">):</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\\\\r\n</span><span class="s">&#39;</span><span class="p">):</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nl</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="n">lines</span><span class="p">)))</span>
        <span class="n">code</span> <span class="o">=</span> <span class="s">&#39;_printlist((</span><span class="si">%s</span><span class="s">,))&#39;</span> <span class="o">%</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lineno</span> <span class="o">+=</span> <span class="n">code</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_code</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process_inline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;!&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#39;_str(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="s">&#39;_escape(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">chunk</span>

    <span class="k">def</span> <span class="nf">write_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="n">line</span><span class="p">,</span> <span class="n">comment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_backward_compatibility</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>
        <span class="n">code</span>  <span class="o">=</span> <span class="s">&#39;  &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">indent_mod</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">+=</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span> <span class="o">+</span> <span class="n">comment</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fix_backward_compatibility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">comment</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parts</span> <span class="ow">and</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;include&#39;</span><span class="p">,</span> <span class="s">&#39;rebase&#39;</span><span class="p">):</span>
            <span class="n">depr</span><span class="p">(</span><span class="s">&#39;The include and rebase keywords are functions now.&#39;</span><span class="p">)</span> <span class="c">#0.12</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>   <span class="k">return</span> <span class="s">&quot;_printlist([base])&quot;</span><span class="p">,</span> <span class="n">comment</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;_=</span><span class="si">%s</span><span class="s">(</span><span class="si">%r</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">parts</span><span class="p">),</span> <span class="n">comment</span>
            <span class="k">else</span><span class="p">:</span>                 <span class="k">return</span> <span class="s">&quot;_=</span><span class="si">%s</span><span class="s">(</span><span class="si">%r</span><span class="s">, </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">parts</span><span class="p">),</span> <span class="n">comment</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineno</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="s">&#39;coding&#39;</span> <span class="ow">in</span> <span class="n">comment</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r&quot;#.*coding[:=]\s*([-\w.]+)&quot;</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">depr</span><span class="p">(</span><span class="s">&#39;PEP263 encoding strings in templates are deprecated.&#39;</span><span class="p">)</span> <span class="c">#0.12</span>
                <span class="n">enc</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">enc</span>
                <span class="k">return</span> <span class="n">line</span><span class="p">,</span> <span class="n">comment</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;coding&#39;</span><span class="p">,</span><span class="s">&#39;coding*&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">line</span><span class="p">,</span> <span class="n">comment</span>


<span class="k">def</span> <span class="nf">template</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get a rendered template as a string iterator.</span>
<span class="sd">    You can use a name, a filename or a template string as first parameter.</span>
<span class="sd">    Template rendering arguments can be passed as dictionaries</span>
<span class="sd">    or directly (as keyword arguments).</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">tpl</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="bp">None</span>
    <span class="n">adapter</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;template_adapter&#39;</span><span class="p">,</span> <span class="n">SimpleTemplate</span><span class="p">)</span>
    <span class="n">lookup</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;template_lookup&#39;</span><span class="p">,</span> <span class="n">TEMPLATE_PATH</span><span class="p">)</span>
    <span class="n">tplid</span> <span class="o">=</span> <span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">lookup</span><span class="p">),</span> <span class="n">tpl</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tplid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TEMPLATES</span> <span class="ow">or</span> <span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;template_settings&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tpl</span><span class="p">,</span> <span class="n">adapter</span><span class="p">):</span>
            <span class="n">TEMPLATES</span><span class="p">[</span><span class="n">tplid</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpl</span>
            <span class="k">if</span> <span class="n">settings</span><span class="p">:</span> <span class="n">TEMPLATES</span><span class="p">[</span><span class="n">tplid</span><span class="p">]</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="ow">in</span> <span class="n">tpl</span> <span class="ow">or</span> <span class="s">&quot;{&quot;</span> <span class="ow">in</span> <span class="n">tpl</span> <span class="ow">or</span> <span class="s">&quot;%&quot;</span> <span class="ow">in</span> <span class="n">tpl</span> <span class="ow">or</span> <span class="s">&#39;$&#39;</span> <span class="ow">in</span> <span class="n">tpl</span><span class="p">:</span>
            <span class="n">TEMPLATES</span><span class="p">[</span><span class="n">tplid</span><span class="p">]</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">tpl</span><span class="p">,</span> <span class="n">lookup</span><span class="o">=</span><span class="n">lookup</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">TEMPLATES</span><span class="p">[</span><span class="n">tplid</span><span class="p">]</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">tpl</span><span class="p">,</span> <span class="n">lookup</span><span class="o">=</span><span class="n">lookup</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">TEMPLATES</span><span class="p">[</span><span class="n">tplid</span><span class="p">]:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&#39;Template (</span><span class="si">%s</span><span class="s">) not found&#39;</span> <span class="o">%</span> <span class="n">tpl</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">dictarg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dictarg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">TEMPLATES</span><span class="p">[</span><span class="n">tplid</span><span class="p">]</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

<span class="n">mako_template</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">template_adapter</span><span class="o">=</span><span class="n">MakoTemplate</span><span class="p">)</span>
<span class="n">cheetah_template</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">template_adapter</span><span class="o">=</span><span class="n">CheetahTemplate</span><span class="p">)</span>
<span class="n">jinja2_template</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">template_adapter</span><span class="o">=</span><span class="n">Jinja2Template</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="n">tpl_name</span><span class="p">,</span> <span class="o">**</span><span class="n">defaults</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Decorator: renders a template for a handler.</span>
<span class="sd">        The handler can control its behavior like that:</span>

<span class="sd">          - return a dict of template vars to fill out the template</span>
<span class="sd">          - return something other than a dict and the view decorator will not</span>
<span class="sd">            process the template, but return the handler result as is.</span>
<span class="sd">            This includes returning a HTTPResponse(dict) to get,</span>
<span class="sd">            for instance, JSON with autojson or other castfilters.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="nd">@functools.wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">DictMixin</span><span class="p">)):</span>
                <span class="n">tplvars</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">tplvars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">template</span><span class="p">(</span><span class="n">tpl_name</span><span class="p">,</span> <span class="o">**</span><span class="n">tplvars</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">template</span><span class="p">(</span><span class="n">tpl_name</span><span class="p">,</span> <span class="n">defaults</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">decorator</span>

<span class="n">mako_view</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">template_adapter</span><span class="o">=</span><span class="n">MakoTemplate</span><span class="p">)</span>
<span class="n">cheetah_view</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">template_adapter</span><span class="o">=</span><span class="n">CheetahTemplate</span><span class="p">)</span>
<span class="n">jinja2_view</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">template_adapter</span><span class="o">=</span><span class="n">Jinja2Template</span><span class="p">)</span>






<span class="c">###############################################################################</span>
<span class="c"># Constants and Globals ########################################################</span>
<span class="c">###############################################################################</span>


<span class="n">TEMPLATE_PATH</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;./&#39;</span><span class="p">,</span> <span class="s">&#39;./views/&#39;</span><span class="p">]</span>
<span class="n">TEMPLATES</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">NORUN</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># If set, run() does nothing. Used by load_app()</span>

<span class="c">#: A dict to map HTTP status codes (e.g. 404) to phrases (e.g. &#39;Not Found&#39;)</span>
<span class="n">HTTP_CODES</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">responses</span>
<span class="n">HTTP_CODES</span><span class="p">[</span><span class="mi">418</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;I&#39;m a teapot&quot;</span> <span class="c"># RFC 2324</span>
<span class="n">HTTP_CODES</span><span class="p">[</span><span class="mi">428</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Precondition Required&quot;</span>
<span class="n">HTTP_CODES</span><span class="p">[</span><span class="mi">429</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Too Many Requests&quot;</span>
<span class="n">HTTP_CODES</span><span class="p">[</span><span class="mi">431</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Request Header Fields Too Large&quot;</span>
<span class="n">HTTP_CODES</span><span class="p">[</span><span class="mi">511</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Network Authentication Required&quot;</span>
<span class="n">_HTTP_STATUS_LINES</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">HTTP_CODES</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

<span class="c">#: The default template used for error pages. Override with @error()</span>
<span class="n">ERROR_PAGE_TEMPLATE</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="si">%%</span><span class="s">try:</span>
<span class="s">    </span><span class="si">%%</span><span class="s">from </span><span class="si">%s</span><span class="s"> import DEBUG, HTTP_CODES, request, touni</span>
<span class="s">    &lt;!DOCTYPE HTML PUBLIC &quot;-//IETF//DTD HTML 2.0//EN&quot;&gt;</span>
<span class="s">    &lt;html&gt;</span>
<span class="s">        &lt;head&gt;</span>
<span class="s">            &lt;title&gt;Error: {{e.status}}&lt;/title&gt;</span>
<span class="s">            &lt;style type=&quot;text/css&quot;&gt;</span>
<span class="s">              html {background-color: #eee; font-family: sans;}</span>
<span class="s">              body {background-color: #fff; border: 1px solid #ddd;</span>
<span class="s">                    padding: 15px; margin: 15px;}</span>
<span class="s">              pre {background-color: #eee; border: 1px solid #ddd; padding: 5px;}</span>
<span class="s">            &lt;/style&gt;</span>
<span class="s">        &lt;/head&gt;</span>
<span class="s">        &lt;body&gt;</span>
<span class="s">            &lt;h1&gt;Error: {{e.status}}&lt;/h1&gt;</span>
<span class="s">            &lt;p&gt;Sorry, the requested URL &lt;tt&gt;{{repr(request.url)}}&lt;/tt&gt;</span>
<span class="s">               caused an error:&lt;/p&gt;</span>
<span class="s">            &lt;pre&gt;{{e.body}}&lt;/pre&gt;</span>
<span class="s">            </span><span class="si">%%</span><span class="s">if DEBUG and e.exception:</span>
<span class="s">              &lt;h2&gt;Exception:&lt;/h2&gt;</span>
<span class="s">              &lt;pre&gt;{{repr(e.exception)}}&lt;/pre&gt;</span>
<span class="s">            </span><span class="si">%%</span><span class="s">end</span>
<span class="s">            </span><span class="si">%%</span><span class="s">if DEBUG and e.traceback:</span>
<span class="s">              &lt;h2&gt;Traceback:&lt;/h2&gt;</span>
<span class="s">              &lt;pre&gt;{{e.traceback}}&lt;/pre&gt;</span>
<span class="s">            </span><span class="si">%%</span><span class="s">end</span>
<span class="s">        &lt;/body&gt;</span>
<span class="s">    &lt;/html&gt;</span>
<span class="si">%%</span><span class="s">except ImportError:</span>
<span class="s">    &lt;b&gt;ImportError:&lt;/b&gt; Could not generate the error page. Please add bottle to</span>
<span class="s">    the import path.</span>
<span class="si">%%</span><span class="s">end</span>
<span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">__name__</span>

<span class="c">#: A thread-safe instance of :class:`LocalRequest`. If accessed from within a</span>
<span class="c">#: request callback, this instance always refers to the *current* request</span>
<span class="c">#: (even on a multithreaded server).</span>
<span class="n">request</span> <span class="o">=</span> <span class="n">LocalRequest</span><span class="p">()</span>

<span class="c">#: A thread-safe instance of :class:`LocalResponse`. It is used to change the</span>
<span class="c">#: HTTP response for the *current* request.</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">LocalResponse</span><span class="p">()</span>

<span class="c">#: A thread-safe namespace. Not used by Bottle.</span>
<span class="n">local</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>

<span class="c"># Initialize app stack (create first empty Bottle app)</span>
<span class="c"># BC: 0.6.4 and needed for run()</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">default_app</span> <span class="o">=</span> <span class="n">AppStack</span><span class="p">()</span>
<span class="n">app</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>

<span class="c">#: A virtual package that redirects import statements.</span>
<span class="c">#: Example: ``import bottle.ext.sqlite`` actually imports `bottle_sqlite`.</span>
<span class="n">ext</span> <span class="o">=</span> <span class="n">_ImportRedirect</span><span class="p">(</span><span class="s">&#39;bottle.ext&#39;</span> <span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span> <span class="k">else</span> <span class="n">__name__</span><span class="o">+</span><span class="s">&quot;.ext&quot;</span><span class="p">,</span> <span class="s">&#39;bottle_</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">module</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">opt</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">parser</span> <span class="o">=</span> <span class="n">_cmd_options</span><span class="p">,</span> <span class="n">_cmd_args</span><span class="p">,</span> <span class="n">_cmd_parser</span>
    <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
        <span class="n">_stdout</span><span class="p">(</span><span class="s">&#39;Bottle </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">%</span><span class="n">__version__</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
        <span class="n">_stderr</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Error: No application specified.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;bottle&#39;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s">&#39;__main__&#39;</span><span class="p">])</span>

    <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">bind</span> <span class="ow">or</span> <span class="s">&#39;localhost&#39;</span><span class="p">),</span> <span class="mi">8080</span>
    <span class="k">if</span> <span class="s">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">host</span> <span class="ow">and</span> <span class="n">host</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;]&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">):</span>
        <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;[]&#39;</span><span class="p">)</span>

    <span class="n">run</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="n">server</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">server</span><span class="p">,</span>
        <span class="n">reloader</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">reload</span><span class="p">,</span> <span class="n">plugins</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">plugin</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span>




<span class="c"># THE END</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Bottle Utils 0.3 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2014-2015, Outernet Inc &lt;hello@outernet.is&gt;.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>