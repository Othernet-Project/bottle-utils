<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>CSRF protection (bottle_utils.csrf) &mdash; Bottle Utils 0.1a4 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1a4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Bottle Utils 0.1a4 documentation" href="index.html" />
    <link rel="next" title="Flash messages (bottle_utils.flash)" href="flash.html" />
    <link rel="prev" title="AJAX (bottle_utils.ajax)" href="ajax.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="flash.html" title="Flash messages (bottle_utils.flash)"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ajax.html" title="AJAX (bottle_utils.ajax)"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Bottle Utils 0.1a4 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="csrf-protection-bottle-utils-csrf">
<h1>CSRF protection (<tt class="docutils literal"><span class="pre">bottle_utils.csrf</span></tt>)<a class="headerlink" href="#csrf-protection-bottle-utils-csrf" title="Permalink to this headline">¶</a></h1>
<p>This module contains decorators and functions for facilitating <a href="#id1"><span class="problematic" id="id2">CSRF_</span></a>
protection.</p>
<div class="section" id="app-configuration">
<h2>App configuration<a class="headerlink" href="#app-configuration" title="Permalink to this headline">¶</a></h2>
<p>Functions in this module require the Bottle application to be <a class="reference external" href="http://bottlepy.org/docs/0.12/configuration.html">configured</a> with
CSRF-specific options.</p>
<p>Here is an example of file-based configuration:</p>
<div class="highlight-python"><div class="highlight"><pre>[csrf]
secret = SomeSecretValue
token_name = _csrf_token
path = /
expires = 600
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">secret</span></tt> setting is the only setting you really must override. Not having
this setting set will result in <tt class="docutils literal"><span class="pre">KeyError</span></tt> exception.</p>
<p>When using dict-based configuration, prefix each key with <tt class="docutils literal"><span class="pre">csrf.</span></tt>.</p>
<p>The keys have following meaning:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">secret</span></tt> setting is a secret key used for setting cookies; it should be
fairly random and difficult to guess</li>
<li><tt class="docutils literal"><span class="pre">token_name</span></tt> setting is the name of the cookie and form field that contain
the token</li>
<li><tt class="docutils literal"><span class="pre">path</span></tt> setting is the path of the cookie</li>
<li><tt class="docutils literal"><span class="pre">expires</span></tt> setting is in seconds and sets the cookie&#8217;s max-age</li>
</ul>
</div>
<div class="section" id="caveat">
<h2>Caveat<a class="headerlink" href="#caveat" title="Permalink to this headline">¶</a></h2>
<p>As with most common CSRF protection schemes, decorators in this module will
prevent the user from opening two forms and submitting them one after the
other. This also applies to cases where forms are fetched from server side
using XHR.</p>
<p>Every form must have a token, and a token must match the one in the cookie.
However, there is only one cookie for the whole site. When you submit a form,
the token in the cookie is replaced with a new one, making tokens in any of the
previously opened forms invalid. The result is that form submission results in
a HTTP 403 response (not authorized).</p>
<p>You need to decide whether you can live with this behavior before using this
module. In case of XHR, consolidating different forms into a single form or
fetching tokens separately may be viable solutions.</p>
</div>
<div class="section" id="module-bottle_utils.csrf">
<span id="functions-and-decorators"></span><h2>Functions and decorators<a class="headerlink" href="#module-bottle_utils.csrf" title="Permalink to this headline">¶</a></h2>
<span class="target" id="module-bottle_utils.csrf"></span><dl class="function">
<dt id="bottle_utils.csrf.csrf_protect">
<tt class="descclassname">bottle_utils.csrf.</tt><tt class="descname">csrf_protect</tt><big>(</big><em>func</em><big>)</big><a class="reference internal" href="_modules/bottle_utils/csrf.html#csrf_protect"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#bottle_utils.csrf.csrf_protect" title="Permalink to this definition">¶</a></dt>
<dd><p>Perform CSRF protection checks. Performs checks to determine if submitted
form data matches the token in the cookie. It is assumed that the GET
request handler successfully set the token for the request and that the
form was instrumented with a CSRF token field. Use the
<a class="reference internal" href="#bottle_utils.csrf.csrf_token" title="bottle_utils.csrf.csrf_token"><tt class="xref py py-func docutils literal"><span class="pre">csrf_token()</span></tt></a> decorator to do this.</p>
<p>If the handler function returns (i.e., it is not interrupted with
<tt class="docutils literal"><span class="pre">bottle.abort()</span></tt>, <tt class="docutils literal"><span class="pre">bottle.redirect()</span></tt>, and similar functions that throw
an exception, a new token is set and response is returned to the requester.
It is therefore recommended to perform a reidrect on successful POST.</p>
<p>Generally, the handler does not need to do anything
CSRF-protection-specific. All it needs is the decorator:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@app.post</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
<span class="nd">@bottle.view</span><span class="p">(</span><span class="s">&#39;myform&#39;</span><span class="p">)</span>
<span class="nd">@csrf_protect</span>
<span class="k">def</span> <span class="nf">protected_post_handler</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">successful</span><span class="p">:</span>
        <span class="n">redirect</span><span class="p">(</span><span class="s">&#39;/someplace&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s">&quot;There were some errors&quot;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="bottle_utils.csrf.csrf_tag">
<tt class="descclassname">bottle_utils.csrf.</tt><tt class="descname">csrf_tag</tt><big>(</big><big>)</big><a class="reference internal" href="_modules/bottle_utils/csrf.html#csrf_tag"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#bottle_utils.csrf.csrf_tag" title="Permalink to this definition">¶</a></dt>
<dd><p>Generte HTML for hidden form field. This is a convenience function to
generate a simple hidden input field. It does not accept any arguments
since it uses the <tt class="docutils literal"><span class="pre">bottle.request</span></tt> object to obtain the token.</p>
<p>If the handler in which this function is invoked is not decorated with
<a class="reference internal" href="#bottle_utils.csrf.csrf_token" title="bottle_utils.csrf.csrf_token"><tt class="xref py py-func docutils literal"><span class="pre">csrf_token()</span></tt></a>, an <tt class="docutils literal"><span class="pre">AttributeError</span></tt> will be
raised.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">HTML markup for hidden CSRF token field</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="bottle_utils.csrf.csrf_token">
<tt class="descclassname">bottle_utils.csrf.</tt><tt class="descname">csrf_token</tt><big>(</big><em>func</em><big>)</big><a class="reference internal" href="_modules/bottle_utils/csrf.html#csrf_token"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#bottle_utils.csrf.csrf_token" title="Permalink to this definition">¶</a></dt>
<dd><p>Create and set CSRF token in preparation for subsequent POST request. This
decorator is used to set the token. It also sets the <tt class="docutils literal"><span class="pre">'Cache-Control'</span></tt>
header in order to prevent caching of the page on which the token appears.</p>
<p>When an existing token cookie is found, it is reused. The existing token is
reset so that the expiration time is extended each time it is reused.</p>
<p>The POST handler must use the <a class="reference internal" href="#bottle_utils.csrf.csrf_protect" title="bottle_utils.csrf.csrf_protect"><tt class="xref py py-func docutils literal"><span class="pre">csrf_protect()</span></tt></a>
decotrator for the token to be used in any way.</p>
<p>The token is available in the <tt class="docutils literal"><span class="pre">bottle.request</span></tt> object as <tt class="docutils literal"><span class="pre">csrf_token</span></tt>
attribute:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@app.get</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
<span class="nd">@bottle.view</span><span class="p">(</span><span class="s">&#39;myform&#39;</span><span class="p">)</span>
<span class="nd">@csrf_token</span>
<span class="k">def</span> <span class="nf">put_token_in_form</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">csrf_token</span><span class="p">)</span>
</pre></div>
</div>
<p>In a view, you can render this token as a hidden field inside the form. The
hidden field must have a name <tt class="docutils literal"><span class="pre">_csrf_token</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;form method=&quot;POST&quot;&gt;
    &lt;input type=&quot;hidden&quot; name=&quot;_csrf_token&quot; value=&quot;{{ csrf_token }}&quot;&gt;
    ....
&lt;/form&gt;
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="bottle_utils.csrf.generate_csrf_token">
<tt class="descclassname">bottle_utils.csrf.</tt><tt class="descname">generate_csrf_token</tt><big>(</big><big>)</big><a class="reference internal" href="_modules/bottle_utils/csrf.html#generate_csrf_token"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#bottle_utils.csrf.generate_csrf_token" title="Permalink to this definition">¶</a></dt>
<dd><p>Generate and set new CSRF token in cookie. The generated token is set to
<tt class="docutils literal"><span class="pre">request.csrf_token</span></tt> attribute for easier access by other functions.</p>
<p>It is generally not necessary to use this function directly.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This function uses <tt class="docutils literal"><span class="pre">os.urandom()</span></tt> call to obtain 8 random bytes when
generating the token. It is possible to deplete the randomness pool and
make the random token predictable.</p>
</div>
</dd></dl>

</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">CSRF protection (<tt class="docutils literal"><span class="pre">bottle_utils.csrf</span></tt>)</a><ul>
<li><a class="reference internal" href="#app-configuration">App configuration</a></li>
<li><a class="reference internal" href="#caveat">Caveat</a></li>
<li><a class="reference internal" href="#module-bottle_utils.csrf">Functions and decorators</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="ajax.html"
                        title="previous chapter">AJAX (<tt class="docutils literal"><span class="pre">bottle_utils.ajax</span></tt>)</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="flash.html"
                        title="next chapter">Flash messages (<tt class="docutils literal"><span class="pre">bottle_utils.flash</span></tt>)</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/csrf.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="flash.html" title="Flash messages (bottle_utils.flash)"
             >next</a> |</li>
        <li class="right" >
          <a href="ajax.html" title="AJAX (bottle_utils.ajax)"
             >previous</a> |</li>
        <li><a href="index.html">Bottle Utils 0.1a4 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Outernet Inc &lt;hello@outernet.is&gt;.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>